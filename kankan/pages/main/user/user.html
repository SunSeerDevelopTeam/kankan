<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>User</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">

		<link rel="stylesheet" href="../../../css/mui.min.css">
		<link href="../../../css/icons-extra.css" rel="stylesheet" />
		<script src="../../../js/jquery-3.2.0.min.js"></script>
		<style>
			html,
			body {
				background-color: #efeff4;
			}
		</style>
		<link rel="stylesheet" type="text/css" href="../../../css/feedback.css" />
		<link rel="stylesheet" href="../../../css/kankan_home.css">
		<link rel="stylesheet" href="../../../css/wu.css">
	</head>

	<body class="mui-fullscreen">
		<!--页面主结构开始-->
		<div id="app" class="mui-views">
			<div class="mui-view">
				<div class="mui-navbar">
				</div>
				<div class="mui-pages">
				</div>
			</div>
		</div>
		<!--页面主结构结束-->
		<!--单页面开始-->
		<div id="setting" class="mui-page">
			<!--页面标题栏开始-->
			<div class="mui-navbar-inner mui-bar mui-bar-nav">
				<button type="button" class="mui-left mui-action-back mui-btn  mui-btn-link mui-btn-nav mui-pull-left">
					<span class="mui-icon mui-icon-left-nav"><font size="4">戻る</font></span>
				</button>
				<h1 class="mui-center mui-title user-title-center"></h1>
				<a href="../../setting/setting.html">
					<button type="button" class="mui-right mui-btn mui-btn-link mui-btn-nav mui-pull-right">
						<span class="mui-icon mui-icon-gear"></span>
					</button>
				</a>
			</div>
			<!--页面标题栏结束-->
			<!--页面主内容区开始-->
			<div class="mui-page-content">
				<div class="mui-scroll-wrapper">
					<div class="tran-page">
						<ul class="mui-table-view">
							<li class="head-img-box">
								<div><img src="../../../images/userPhoto.png" width="150" height="150" class="headimg"></div>
								<div class="mui-pull-caption">
									<a href="#uinfoedite">
										<button type="button" class="mui-btn mui-btn-grey mui-btn-block editebutton">プロフィール編集</button>
									</a>
								</div>
								<br>
								<div>
									<ul class="user-num">
										<li class="user-num-comment">
											<font size="2"><span>評価：</span><span class="commentnum"></span></font>
											
										</li>
										<li class="user-num-sell">
											<font size="2"><span>出品数：</span><span class="sellnum"></span></font>	
										</li>
										<li class="user-num-sell2">
											<font size="2"><span>チケット数：</span><span class="ticknum"></span></font>											
										</li>
									</ul>
								</div>
								<ul class="user-comment-list">
									<li class="user-comment-grid">
										<img height="30%" width="30%" src="../../../images/Good.PNG"/>
										<div class="user-comment-num good"></div>
									</li>
									<li class="user-comment-grid2">
										<img height="30%" width="30%"  src="../../../images/Normal.PNG"/>
										<div class="user-comment-num normal"></div>
									</li>
									<li class="user-comment-grid2">
										<img height="30%" width="30%" src="../../../images/Bad.PNG"/>
										<div class="user-comment-num bad"></div>
									</li>
									<li class="user-comment-grid3 usercommentlist">
										<a href="../products/commentlist.html#allcommentlist">
											<span class="mui-icon mui-navigate-right"></span>
										</a>
									</li>
								</ul>
								<ul class="user-comment-list">
									<li class="user-point-grid">
										<a href="#">
											<font color="#AAAAAA" size="2">
												<span class="mui-icon-extra mui-icon-extra-share"></span>　ポイント
											</font>
										</a>
									</li>
									<li class="user-point-grid2">
											<font size="2" class="point"></font>
									</li>
									<li class="user-point-grid">
										<a href="#area">
											<font color="#AAAAAA" size="2">
												<span class="mui-icon mui-icon-paperplane"><font size="3" class="address"></font></span>
											</font>
										</a>
									</li>
								</ul>
							</li>
						</ul>
						<ul class="user-goods-list">
							<li class="user-goods-title-grid">
								<div id="products" class="user-product-tab1" onclick="switchs(this)">
									<font size="2" color="#FFFFFF">出品中アイテム</font>
								</div>
							</li>
							<li class="user-goods-title-grid">
								<div id="favourate" class="user-product-tab22" onclick="switchs(this)">
									<font size="2" color="#FFFFFF">いいねした<br>アイテム</font>
								</div>
							</li>
							<li class="user-goods-title-grid">
								<div id="friends" class="user-product-tab32" onclick="switchs(this)">
									<font size="2" color="#FFFFFF">気になる</font>
								</div>
							</li>
						</ul>
						<!--Produced products--->
						<div id="myproducts" class="mui-slider ka_aboutupro">
					        <div class="mui-slider-group myproductshow">
							</div>
						</div>
						<!--favourate products--->
						<div id="myfavourate" class="mui-slider ka_aboutupro" style="height:100%; display:none;">
					        <div class="mui-slider-group myfavourateshow">
							</div>
						</div>
						<!--favourate person--->
						<div id="myfriends" class="mui-slider ka_aboutupro" style="height:100%; display:none;">
					        <div class="mui-slider-group">
								<div class="mui-slider-item" style="height:25%">
									<ul class="user-item-list">
										<li class="user-goods-grid detail">
											<a id="1" href="#">
												<img height="90%" width="90%" src="../../../images/cbd.jpg">
											</a>
										</li>
										<li class="user-goods-grid detail">
											<a id="1" href="#">
												<img height="90%" width="90%" src="../../../images/cbd.jpg">
											</a>
										</li>
										<li class="user-goods-grid detail">
											<a id="1" href="#">
												<img height="90%" width="90%" src="../../../images/cbd.jpg">
											</a>
										</li>
										<li class="user-goods-grid detail">
											<a id="1" href="#">
												<img height="90%" width="90%" src="../../../images/cbd.jpg">
											</a>
										</li>
										<li class="user-goods-grid detail">
											<a id="1" href="#">
												<img height="90%" width="90%" src="../../../images/cbd.jpg">
											</a>
										</li>
										<li class="user-goods-grid detail">
											<a id="1" href="#">
												<img height="90%" width="90%" src="../../../images/cbd.jpg">
											</a>
										</li>
									</ul>
								</div>
								<div class="mui-slider-item" style="height:25%">
									<ul class="user-item-list">
										<li class="user-goods-grid detail">
											<a id="1" href="#">
												<img height="90%" width="90%" src="../../../images/muwu.jpg">
											</a>
										</li>
										<li class="user-goods-grid detail">
											<a id="1" href="#">
												<img height="90%" width="90%" src="../../../images/muwu.jpg">
											</a>
										</li>
										<li class="user-goods-grid detail">
											<a id="1" href="#">
												<img height="90%" width="90%" src="../../../images/muwu.jpg">
											</a>
										</li>
										<li class="user-goods-grid detail">
											<a id="1" href="">
												<img height="90%" width="90%" src="../../../images/muwu.jpg">
											</a>
										</li>
										<li class="user-goods-grid detail">
											<a id="1" href="">
												<img height="90%" width="90%" src="../../../images/muwu.jpg">
											</a>
										</li>
										<li class="user-goods-grid detail">
											<a id="1" href="#">
												<img height="90%" width="90%" src="../../../images/muwu.jpg">
											</a>
										</li>
									</ul>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!--页面主内容区结束-->
		</div>
		<!--单页面结束-->
		<div id="area" class="mui-page">
			<div class="mui-navbar-inner mui-bar mui-bar-nav">
				<button type="button" class="mui-left mui-action-back mui-btn  mui-btn-link mui-btn-nav mui-pull-left">
					<span class="mui-icon mui-icon-left-nav"></span>
				</button>
				<h1 class="mui-center mui-title">地址设置</h1>
			</div>
			<div class="mui-page-content">
				<div class="mui-scroll-wrapper">
					<div class="mui-scroll">
						<ul class="mui-table-view">
							<li class="mui-table-view-cell">
								<a class="mui-navigate-right">
									东京
								</a>
							</li>
							<li class="mui-table-view-cell">
								<a class="mui-navigate-right">
									大阪
								</a>
							</li>
							<li class="mui-table-view-cell">
								<a class="mui-navigate-right">
									北海道
								</a>
							</li>
						</ul>

					</div>
				</div>
			</div>
		</div>
		<!--单页面结束-->
		<div id="uinfoedite" class="mui-page">
			<div class="mui-navbar-inner mui-bar mui-bar-nav">
				<button type="button" class="mui-left mui-action-back mui-btn  mui-btn-link mui-btn-nav mui-pull-left">
					<span class="mui-icon mui-icon-left-nav"></span>
				</button>
				<h1 class="mui-center mui-title">プロフィール編集</h1>
			</div>
			<div class="mui-page-content">
				<div class="mui-scroll-wrapper">
					<div class="mui-scroll">
						<form method="post" name="userinfosub" id="userinfosub">
							<div style="margin: 0.3em;">
								<div style="width: 30%;text-align: left;margin-left: -1em;" class="head-img-box">
									<img src="../../../images/userPhoto.png" height="50" width="50" class="headimg"  />
								</div>
								<div style="width: 78%;float: right;margin-top: -4.5em;">
								<h6>用户名</h6>
								<input type="text" name="nickname" id="nickname" value="" placeholder="mary" style="font-size: 14px;"maxlength="50" />
								</div>
								<h6>介绍文</h6>
								<textarea name="introduce" id="introduce" rows="5" cols="" style="font-size: 14px;" maxlength="500"></textarea>
								<h6>语言</h6>
								<div style="background-color: #FFFFFF;">
									<div class="mui-input-row mui-checkbox ">
									    <label>日本语</label>
									    <input name="userlanageval" type="checkbox" value="0">
									</div>
									<div class="mui-input-row mui-checkbox ">
									    <label>汉语</label>
									    <input name="userlanageval" type="checkbox" value="1">
									</div>
									<div class="mui-input-row mui-checkbox ">
									    <label>英语</label>
									    <input name="userlanageval" type="checkbox" value="2">
									</div>
									<div class="mui-input-row mui-checkbox ">
									    <label>韩语</label>
									    <input name="userlanageval" type="checkbox" value="3">
									</div>
				    	     </div>
								<button type="button" class="mui-btn mui-btn-red" style="width: 100%;margin-top: 2em;" onclick="userinfosubmit()">更 新</button>
						</div>
						</form>
						
					</div>
				</div>
			</div>
		</div>
	</body>
	<script src="../../../js/mui.min.js"></script>
	<script src="../../../js/mui.view.js "></script>
	<script src="../../../js/mui.picker.js"></script>
	<script src="../../../js/mui.poppicker.js"></script>
	<script src='../../../js/feedback.js'></script>
	<script src="../../../js/jquery-3.2.0.min.js"></script>
	<script src="../../../js/language.js"></script>
	<script src="../../../js/sha256.js"></script>
	<script src="../../../js/common.js"></script>
	<script>
		mui.init({
				swipeBack: false,
				preloadPages: [{
						id: 'commentlist.html',
						url: '../products/commentlist.html'
					},
					{
						id: 'detail.html',
						url: '../products/detail.html'
					},{
						id: 'product_login.html',
						url: '../products/product_login.html'
					}
				]
			});
		//初始化单页view
		var viewApi = mui('#app').view({
			defaultPage: '#setting'
		});
		//初始化单页的区域滚动
		mui('.mui-scroll-wrapper').scroll();
		var view = viewApi.view;
		(function($) {
			//处理view的后退与webview后退
			var oldBack = $.back;
			$.back = function() {
				if(viewApi.canBack()) { 
					viewApi.back();
				} else { 
					oldBack();
				}
			};
			view.addEventListener('pageBeforeShow', function(e) {
				//				console.log(e.detail.page.id + ' beforeShow');
			});
			view.addEventListener('pageShow', function(e) {
				//				console.log(e.detail.page.id + ' show');
			});
			view.addEventListener('pageBeforeBack', function(e) {
				//				console.log(e.detail.page.id + ' beforeBack');
			});
			view.addEventListener('pageBack', function(e) {
				//				console.log(e.detail.page.id + ' back');
			});
		})(mui);
		//更换头像
		mui(".head-img-box").on("tap", ".headimg", function(e) {
			if(mui.os.plus){
				var a = [{
					title: "拍照"
				}, {
					title: "从手机相册选择"
				}];
				plus.nativeUI.actionSheet({
					title: "修改头像",
					cancel: "取消",
					buttons: a
				}, function(b) {
					switch (b.index) {
						case 0:
							break;
						case 1:
							getImage();
							break;
						case 2:
							galleryImg();
							break;
						default:
							break
					}
				})	
			}
			
		});
		function getImage() {
			var c = plus.camera.getCamera();
			c.captureImage(function(e) {
				plus.io.resolveLocalFileSystemURL(e, function(entry) {
					var localurl = entry.toLocalURL();
					$(".headimg").attr("src",localurl);
					//compressImg(localurl);
				}, function(e) {
					console.log("Read the picture file error：" + e.message);
				});
			}, function(s) {
				console.log("error" + s);
			}, {
				filename: "_doc/camera/"
			})
		}
		
		function galleryImg() {
			plus.gallery.pick(function(a) {
				plus.io.resolveLocalFileSystemURL(a, function(entry) {
					var localURL2 = entry.toLocalURL();
					$(".headimg").attr("src",localURL2);
		
				}, function(e) {
					console.log("Read photo file error：" + e.message);
				});
			}, function(a) {}, {
				filter: "image"
			})
		};

		//Set the page
//		document.getElementById('setting').addEventListener('tap',function(){
//			//Open about the page
//		  mui.openWindow({
//		    url: '../../../../../../setting/setting.html',
//		    id:'setting',
//		  });
//		});
		//Commodity switch
		function switchs(e) {
			if(e.id == "products") {
				// click 出品中アイテム
				$("#myfavourate").hide();
				$("#myfriends").hide();
				$("#myproducts").show();
				$("#favourate").removeClass("user-product-tab2");
				$("#favourate").addClass("user-product-tab22");
				$("#friends").removeClass("user-product-tab3");
				$("#friends").addClass("user-product-tab32");
				$("#products").removeClass("user-product-tab12");
				$("#products").addClass("user-product-tab1");
			} else if(e.id == "favourate") {
				// click いいねをしたアイテム
				$("#myproducts").hide();
				$("#myfriends").hide();
				$("#myfavourate").show();
				$("#products").removeClass("user-product-tab1");
				$("#products").addClass("user-product-tab12");
				$("#friends").removeClass("user-product-tab3");
				$("#friends").addClass("user-product-tab32");
				$("#favourate").removeClass("user-product-tab22");
				$("#favourate").addClass("user-product-tab2");
			} else {
				// click 気になる
				$("#myproducts").hide();
				$("#myfavourate").hide();
				$("#myfriends").show();
				$("#products").removeClass("user-product-tab1");
				$("#products").addClass("user-product-tab12");
				$("#favourate").removeClass("user-product-tab2");
				$("#favourate").addClass("user-product-tab22");
				$("#friends").removeClass("user-product-tab32");
				$("#friends").addClass("user-product-tab3");
			}
		}
		function clickusercomment(ueid){
			var commentPage = null;
			mui(".usercommentlist").on("tap","a",function(){
				var ucid = ueid;
						if(!commentPage) {
							commentPage = plus.webview.getWebviewById('commentlist.html');
						}
						mui.fire(commentPage, 'ucid', {
							id: ucid
						});
						mui.openWindow({
							id: 'commentlist.html'
						});
			});
		}
		function clickdetail(){
			var detailPage = null;
			mui('.detail').on('tap', 'a', function(e) {
				var id = this.getAttribute('id');
				//var id="100001";
				
				if(!detailPage) {
					detailPage = plus.webview.getWebviewById('detail.html');
				}
				mui.fire(detailPage, 'cid', {
					id: id
				});
				mui.openWindow({
					id: 'detail.html'
				});
			});
		}
		function clickeditepro(){
			var editePage = null;
			mui('.codedite').on('tap', 'a', function(e) {
				var eid = this.getAttribute('id');
				//var eid="226";
				if(!editePage) {
					editePage = plus.webview.getWebviewById('product_login.html');
				}
				mui.fire(editePage, 'eid', {
					id: eid
				});
				mui.openWindow({
					id: 'product_login.html'
				});
			});
		}
		function showuser(results){
			$(".myfavourateshow").empty();
			$(".myproductshow").empty();
			var uaddress=results.data.address;
			var ucomentnum=results.data.comment_cnt;
			var unick_name=results.data.nick_name;
			if(results.data.user_photo==""){
				var user_photo="../../../images/userPhoto.png";
			}else{
				var user_photo=results.data.user_photo;
			}
			var user_point=results.data.user_point;
			var ucomoditynum=results.data.exhibit_cnt;
			var ugoodnum=results.data.user_opinion_h_count;
			var unormalnum=results.data.user_opinion_m_count;
			var badnum=results.data.user_opinion_l_count;
			var uname=results.data.user_name;
			var address=results.data.address;
			var uintroduce=results.data.introduce;
			var uticknum=results.data.user_ticket;
			$(".headimg").attr("src",user_photo);
			$(".commentnum").html(ucomentnum);
			$(".sellnum").html(ucomoditynum);
			$(".good").html(ugoodnum);
			$(".normal").html(unormalnum);
			$(".bad").html(badnum);
			$(".address").html(address);
			$("#nickname").val(unick_name);
			$(".point").html(user_point);
			$(".mui-title").html(uname);
			$("#introduce").val(uintroduce);
			$(".ticknum").html(uticknum);
			var language=results.data.talk_flag;
			var userlanageval=document.getElementsByName('userlanageval');
			for(var ukey=0;ukey<userlanageval.length;ukey++){
				console.log(ukey);
				var eachvalue=userlanageval[ukey].value;
				if(language.indexOf(eachvalue) >= 0){
					userlanageval[ukey].checked="checked";
				}
			}
			var exhibit_commdata=results.data.exhibit_comm;
			var exhibit_html='<div class="mui-slider-item" style="height:25%">';
				exhibit_html+='<ul class="user-item-list">';
			for(var ex=0; ex<exhibit_commdata.length;ex++){
				var k = ex + 1 * 1;
				var commexid=exhibit_commdata[ex].commodity_id;
				var commeximg_url=exhibit_commdata[ex].img_url;
				exhibit_html+='<li class="user-goods-grid codedite">';
				exhibit_html+='<a id="'+commexid+'" href="#">';
				exhibit_html+='<img style="width: 113px;height: 76px;" src="'+commeximg_url+'">';
				exhibit_html+='</a>';
				exhibit_html+='</li>';
				var yunum=k%6;
				if(yunum==0 || k==exhibit_commdata.length){
					exhibit_html+='</ul></div>';
				}
				if(yunum==0 && k< exhibit_commdata.length){
					exhibit_html+='<div class="mui-slider-item" style="height:25%">';
					exhibit_html+='<ul class="user-item-list">';
				}
			}
			$(".myproductshow").html(exhibit_html);
			//praise commodity list
			var praise_commdata=results.data.praise_comm;
			var praise_html='<div class="mui-slider-item" style="height:25%">';
				praise_html+='<ul class="user-item-list">';
			for(var pi=0; pi<praise_commdata.length;pi++){
				var ki = pi + 1 * 1;
				var praisepid=praise_commdata[pi].commodity_id;
				var praiseimg_url=praise_commdata[pi].img_url;
				praise_html+='<li class="user-goods-grid detail">';
				praise_html+='<a id="'+praisepid+'" href="#">';
				praise_html+='<img style="width: 113px;height: 76px;" src="'+praiseimg_url+'">';
				praise_html+='</a>';
				praise_html+='</li>';
				var kiunum=ki%6;
				if(kiunum==0 || ki==praise_commdata.length){
					praise_html+='</ul></div>';
				}
				if(kiunum==0 && ki< praise_commdata.length){
					praise_html+='<div class="mui-slider-item" style="height:25%">';
					praise_html+='<ul class="user-item-list">';
				}
			}
			$(".myfavourateshow").html(praise_html);
			mui('.mui-slider').slider().gotoItem(0);
			var userid=results.myid;
			clickusercomment(userid);
			clickdetail();
			clickeditepro();
		}
		function userinfosubmit(){
			var nickname=document.userinfosub.nickname.value;
			var introduce=document.userinfosub.introduce.value;
			var userlanageval=document.getElementsByName('userlanageval');
			var talk_flag="";
			for(var ui=0;ui<userlanageval.length;ui++){
				if(userlanageval[ui].checked==true){
					talk_flag+=","+userlanageval[ui].value;
				}
			}
			var talk_flagtru=talk_flag.substr(1);
			//compress Image
			var path=$(".headimg").attr("src");
			var currenttime = Date.parse(new Date());
			plus.zip.compressImage({
					src: path,
					dst: "_doc/" + currenttime + ".jpg",
					quality: 20,
					overwrite: true,
					format: "jpg",
					width: "auto",
					height: "auto"
				},
				function(event) {
					console.log("Compress success!");
					var target = event.target;
					var size = event.size; // （Byte）
					var width = event.width; // px
					var height = event.height; // px
					console.log("size:"+size);
					submitvalues(target);//upload
				},
				function(error) {
					alert("Compress error!" + error.message);
				});
				function submitvalues(target){
					var serverurl=Api.url.User.userinfo;
					console.log(target);
					//$(".headimg").attr("src",target);
					var wt = plus.nativeUI.showWaiting();
					var task = plus.uploader.createUpload(serverurl, {
						method: "post"
					}, function(t, status) {
						if(status == 200) {
							console.log("upload success:" + t.responseText);
							console.log("upload success!");
							mui.alert("更新成功！");
							wt.close();
						} else {
							console.log("upload error:" + status);
							console.log("upload error:" + t.responseText);
							wt.close();
						}
					});
					//add parameter
					task.addData("tokencheck", Api.getToken()); //Api.getToken()
					task.addData("signcheck", Api.createSignInfo());
					task.addData("flag","info");
					task.addData("nick_name",nickname);
					task.addData("talk_flag",talk_flagtru);
					task.addData("introduce",introduce);
					task.addFile(target, { key: "image" });
					task.start();
					var parms2={
						"flag":"address",
					};
					Repository.User.userinfo(parms2, {
						ok: function(data) {
							console.log("success");
							console.dir(data);
						},
						ng: function(data) {
							Log.d(data);
							if(data == "1000") {
								alert(TextMessage.test);
							} else {
								alert("other error code:" + data);
							}
						}
					});
				}
		}
		//message show
		mui.plusReady(function(){
			var params={};
			Repository.User.Usershow(params, {
				ok: function(data) {
					console.log("success");
					console.dir(data);
					showuser(data);
				},
				ng: function(data) {
					Log.d(data);
					if(data == "1000") {
						alert(TextMessage.test);
					} else {
						alert("other error code:" + data);
					}
				}
			});
		});
		//user lanage
		
	</script>

</html>