<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>productslist</title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../../../css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" href="../../../css/kankan_home.css" />
		<link rel="stylesheet" href="../../../css/iconmyfont.css" />
		<style>
			.reprot{
				color:coral;
				padding:10px;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title lang" data-locale="detli_title"></h1>
		</header>
		<div  id="reloadpage" onclick="reloadpage()" style="display: none;"><font size="2" class="lang" data-locale="networkerror"></font></div>
		<div id="loading" class="mui-content ka_userbox">
			<div class="spinner">
			  <div class="double-bounce1"></div>
			  <div class="double-bounce2"></div>
			</div>
		</div>
		<div class="mui-content ka_mainbox" style="display: none;">
		<div id="pullrefresh" class="mui-scroll-wrapper">
			<div class="mui-scroll" >
				<ul class="mui-table-view" >
					<li class="mui-table-view-cell">
						<div class="ka_userbox">
							<img src="" class="ka_touxiangimg" width="50" height="50" />
							<div>
								<b class="uname"></b>
								
							</div>
							<font color="#808080" size="2"><span class="lang" data-locale="det_coments"></span>:
								<font color="#007AFF" class="ucomment"></font>&nbsp;&nbsp;&nbsp;
								<span class="lang" data-locale="det_producednum"></span>:
								<font color="#007AFF" class="uproducts"></font>
								
							</font>
							<span  class="mui-icon iconfont icon-tousu reprot"></span>
						</div>
					</li>
					<li class="mui-table-view-cell commentlist">
						<a href="commentlist.html">
							<div class="mui-navigate-right ka_userbox commentlists">
									<div class="mui-pull-right ka_commentlevelbox">
										<img src="../../../images/Bad.PNG" width="30" height="30">
										<div class="ka_comlevnumber badnum"></div>
									</div>
									<div class="mui-pull-right ka_commentlevelbox">
										<img src="../../../images/Normal.PNG" width="30" height="30">
										<div class="ka_comlevnumber normalnum"></div>
									</div>
									<div class="mui-pull-right ka_commentlevelbox">
										<img src="../../../images/Good.PNG" width="30" height="30">
										<div class="ka_comlevnumber goodnum"></div>
									</div>
							</div>
							<input type="hidden" value="" id="commid" name="commid" />
						</a>
					</li>
				</ul>
			<!---author say---->
			<!--<ul class="mui-table-view" style="margin:1em 0.5em;">
			            <li class="mui-table-view-cell">
			                <p>
			                    Item 1Item 1Item 1Item 1Item 1Item 1Item 1Item 1Item 1Item 1
			                </p>
			            </li>
		       </ul>-->
			<!--product list-->
					<ul class="mui-table-view mui-grid-view comditylists" style="margin-top: -1em;">
					</ul>
				</div>
			</div>
			<input type="hidden" name="uids" id="uids" value="" />
			<div id="report" class="mui-popover mui-popover-action mui-popover-bottom">
				<ul class="mui-table-view">
					<li class="mui-table-view-cell">
						<a id="see" href="#" style="color: #9C9C9C" disabled="true"></a>
					</li>
					<li class="mui-table-view-cell">
						<a id="reportUser" onclick="complaint()" style="color: #007aff"></a>
					</li>
				</ul>
				<ul class="mui-table-view">
					<li class="mui-table-view-cell">
						<a href="#report" style="color: #007aff"></a>
					</li>
				</ul>
		    </div>
		</div>
		<script src="../../../js/mui.min.js"></script>
		<script src="../../../js/jquery-3.2.0.min.js"></script>
		<script src="../../../js/language.js"></script>
		<script src="../../../js/sha256.js"></script>
		<script src="../../../js/common.js"></script>
		<script type="text/javascript">
			var uid;
			var page=0;
			mui.plusReady(function() {
				if(mui.os.ios){
					$(".mui-scroll").attr("style","padding-top: 1.1em;");
				}
				var self = plus.webview.currentWebview();
				uid = self.prolid;
				$("#uids").val(uid);
				mui.init({
					swipeBack: false,
					preloadPages: [
						{
							id: 'detail.html',
							url: 'detail.html'
						}
					],
					pullRefresh: {
						container: '#pullrefresh',
//						down: {
//							callback: pulldownRefresh
//						},
						up: {
							contentrefresh:TextMessage.update,
							contentinit: TextMessage.upmore,
							contentdown: TextMessage.upmore,
							contentnomore: TextMessage.nomore,
							callback: pullupRefresh,
							
						}
					}
	//				beforeback: function() {
	//					location.reload();
	//			    }
				});
				getmessage(uid);
			})
			//function clickwarn(){
				mui('.ka_userbox').on("tap",".icon-tousu",function(e){
					if(mui.os.plus){
						mui('#report').popover('toggle');	
					}
				});
			//}
			function reloadpage(){
				location.reload();
			}
			function pullupRefresh() {
				var usid=$("#uids").val();
				setTimeout(function() {
					getmessage(usid);
				}, 1500);
			}
			function complaint(){
				mui("#report").popover('hide');
				var userid=$("#uids").val();
				var paramport={
					"comm_userid":userid,
				}
				Repository.Commodity.reportUser(paramport, {
					ok: function(data) {
						Log.d("success");
						var user = data.data;
						console.log(user);
						mui.openWindow({
							id: 'complaintuser',
							url: "complaintuser.html",
							extras: {
						        "report_userid": user.report_userid,
						        "report_nickname":user.report_nickname,
						        "report_email":user.report_email,
						        "whistlebluser_id":user.whistlebluser_id,
						        "whistleblnickname":user.whistleblnickname,
						        "whistleblemail":user.whistleblemail
					        } 
						});
					},
					ng: function(data) {
						Log.d(data);
						if(data == "2001") {
							$("#loading").show();
							$(".mui-content").hide();
						}
						if(data == "1000") {
							mui.toast(TextMessage.test, {
								duration: 'long',
								type: 'div'
							});
							mui.openWindow({
								id: 'login',
								url: "../../login/login.html"
							});
						}
						if(data == "2004") {
							mui.toast(TextMessage.operation_error, {
								duration: 'long',
								type: 'div'
							});
						}
						if(data == "3022") {
							mui.toast(TextMessage.comodityrepot_repeat, {
								duration: 'long',
								type: 'div'
							});
						}
					},
					error:function(errortypetext){
						$("#reloadpage").html(errortypetext);
						$(".mui-content").hide();
						$("#reloadpage").show();
					}
				});
			}
			//get message
			function getmessage(uid) {
				var params = {
					"user_id": uid,
					"page_num":page,
				};
				Repository.Commodity.commodityulist(params, {
					ok: function(data) {
						Log.d("success");
						messageshow(data);
					},
					ng: function(data) {
						Log.d(data);
					},
					error:function(errortypetext){
						$("#reloadpage").html(errortypetext);
						$("#reloadpage").show();
						$(".ka_mainbox").hide();
						$("#loading").hide();
					}
				});
			}

			function messageshow(results) {
//				$(".comditylists").empty();
//				$(".ka_touxiangimg").empty();
//				$(".uname").empty();
//				$(".uproducts").empty();
//				$(".ucomment").empty();
				var commodity = results.data;
				var uname = commodity.user_name;
				var uimage = commodity.user_photo;
				var userid = commodity.user_id;
				var ucomentnum = commodity.user_comment_count;
				var ucomeditynum = commodity.user_commodity_count;
				var goodcoment = commodity.user_opinion_h_count;
				var normalcoment = commodity.user_opinion_m_count;
				var badcoment = commodity.user_opinion_l_count;
				$("#commid").val(userid);
				$(".uname").html(uname);
				$(".ka_touxiangimg").attr("src", uimage);
				$(".ucomment").html(ucomentnum);
				$(".uproducts").html(ucomeditynum);
				$(".goodnum").html(goodcoment);
				$(".normalnum").html(normalcoment);
				$(".badnum").html(badcoment);
				var commodityarr = commodity.commoditys;
				var commoditylength = commodityarr.length;
				var imgwidth=parseInt($(window).width())/3-17;
				var allcount=commodity.all_comm_num;
				var allcomiditynum=15*page;
				mui('#pullrefresh').pullRefresh().endPullupToRefresh((allcount <=allcomiditynum));
				for(i = 0; i < commoditylength; i++) {
					var ucommodityobj = JSON.stringify(commodityarr[i]);
					var ucommodityinfo = $.parseJSON(ucommodityobj);
					var commodityid = ucommodityinfo.commodity_id;
					var comdityimage = ucommodityinfo.commodity_thu_photo_url;
					var realwidth=ucommodityinfo.comm_img_width;
					var realheight=ucommodityinfo.comm_img_height;
					var leftpx=0;
					var oribi=realheight/realwidth;
					var showwidth=imgwidth/oribi;
					var showheight=oribi*imgwidth;
					var cha1=showheight-imgwidth;
					if(cha1>0){
						toppx=cha1/2;
					}else{
						toppx=0;
					}
					if(comdityimage==""){
						comdityimage="./../../images/nopic.jpg";
					}
					var html = new Util.StringBuilder();
					html.append('<li class="mui-table-view-cell mui-media mui-col-xs-4 detail ka_imgoption2" style="height:'+imgwidth+'px;over-flow:hidden;">')
						.appendFormat('<a href="detail.html" id="{0}">', commodityid)
						.appendFormat('<img class="mui-media-object" src="{0}" style="width:100%;vertical-align: middle;margin-top:-'+toppx+'px;" onerror="this.src='+"'../../../images/nopic.jpg'"+'">', comdityimage)
						.append('</a>')
						.append('</li>');
					$(".comditylists").append(html.toString());
				}
				//go detail page
				var detailPage = null;
				mui('.detail').on('tap', 'a', function(e) {
					var id = this.getAttribute('id');
					if(!detailPage) {
						detailPage = plus.webview.getWebviewById('detail.html');
					}
					mui.fire(detailPage, 'cid', {
						id: id
					});
					mui.openWindow({
						id: 'detail.html'
					});
				});
				$(".mui-content").show();
				$("#loading").hide();
				page++;
			}
			var commentPage = null;
			//go comment list			
			mui('.commentlist').on('tap', 'a', function(e) {
				var ucid = $("#commid").val();
//				if(!commentPage) {
//					commentPage = plus.webview.getWebviewById('commentlist.html');
//				}
//				mui.fire(commentPage, 'ucid', {
//					id: ucid
//				});
				mui.openWindow({
					id: 'commentlist',
					url: 'commentlist.html?ucid='+ucid,
					extras:{
						ucid:ucid
					}
				});
			});
			$('#see').text(TextMessage.sharetitle);
			$('#reportUser').text(TextMessage.complaintuser);
			$("[href='#report']").html("<b>" + TextMessage.cancel + "</b>");
		</script>
	</body>

</html>