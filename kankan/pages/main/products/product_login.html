<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>product_login</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="stylesheet" href="../../../css/mui.min.css">
		<link rel="stylesheet" href="../../../css/kankan_home.css">
		<link href="../../../css/mui.picker.css" rel="stylesheet" />
		<link href="../../../css/mui.poppicker.css" rel="stylesheet" />
	</head>
	<body class="mui-fullscreen">
		<!--page main-->
		<div id="app" class="mui-views">
			<div class="mui-view">
				<div class="mui-navbar">
				</div>
				<div class="mui-pages">
				</div>
			</div>
		</div>
		<!--page main end-->
	<div id="productlogin" class="mui-page">
		<!--page title begin-->
			<div class="mui-navbar-inner mui-bar mui-bar-nav">
				<button type="button" class="mui-left mui-action-back mui-btn  mui-btn-link mui-btn-nav mui-pull-left">
					<span class="mui-icon mui-icon-left-nav"></span>
				</button>
				<h1 class="mui-center mui-title lang" data-locale="commodity_login"></h1>
			</div>
			<!--page title end-->
			<!--page main start-->
			<div class="mui-page-content">
			<form action="" method="post" name="publishcomodity" id="publishcomodity">
				<div class="mui-scroll-wrapper">
					<div class="mui-scroll">
						<div class="mui-content kankan_jyimgbox">
							 <h5 class="ka_proloh5 ka_propicfonts lang" data-locale="commodity_photos"></h5>
							<div class="ka_prologbox0 z_photo">
								<div class="z_file" style="background-image: url(../../../images/iconfont-tianjia.png);" id="gallery">
									<!--<input type="file" name="file" id="file" value=""  class="takepic" accept="image/*" multiple onchange="imgChange('z_photo','z_file');" />-->
								</div>
								<div class="mui-pull-right mui-icon mui-icon-camera takepic" id="takepic"></div>
							</div>
							<!--mask-->
					        <div class="z_mask">
					            <!--alert box-->
					            <div class="z_alert">
					                 <p class="lang" data-locale="commodity_photodet"></p>
					                <p>
					                    <span class="z_cancel lang" data-locale="det_goodconcel"></span>
					                    <span class="z_sure lang" data-locale="register"></span>
					                </p>
					            </div>
					        </div>
							     <br />
							  <input type="hidden" name="" id="0" value="0" class="imgname" />
			            	 <input type="hidden" name="" id="1" value="0" class="imgname" />
			            	 <input type="hidden" name="" id="2" value="0" class="imgname" />
			            	 <input type="hidden" name="" id="3" value="0" class="imgname" />
							     <div class="ka_prologbox">
								     <h5 class="ka_proloh5 lang" data-locale="commodity_name"></h5>
								    <ul class="mui-table-view">
							            <li class="mui-table-view-cell">
						                   <input type="text" class="lang" data-locale="commodity_namelength" id="comm_name" name="comm_name" maxlength="40">
							            </li>
							            <li class="mui-table-view-cell">
							                 <textarea  class="ka_noborder" maxlength="1000" id="comm_detail" name="comm_detail"></textarea>
							            </li>
							        </ul>
							     </div>
							     <br />
							     <div class="ka_prologbox">
								     <h5 class="ka_proloh5 lang" data-locale="commodity_detail"></h5>
								    <ul class="mui-table-view">
							            <li class="mui-table-view-cell" >
							                <div class="mui-navigate-right"   id="showCityPicker">
							                    	<span class="ka_proinfo lang" data-locale="commodity_sorts" ></span>
							                    	<div class="mui-pull-right ka_bitian lang" data-locale="commodity_must" id="bitian1"></div>
							                    	<div id='sortResult' class="ui-alert mui-pull-right ka_sortname"></div>
							                    	<input type="hidden" name="classify_id" id="classify_id" value="" />
							                </div>
							                
							            </li>
							            <li class="mui-table-view-cell">
							                <a class="mui-navigate-right" href="#productstaute" id="prostuat">
							                     	<span class="ka_proinfo lang" data-locale="commodity_stuates"></span>
							                     	<div class="mui-pull-right ka_bitian lang" data-locale="commodity_must"></div>
							                     	<input type="hidden" name="comm_state" id="comm_state" value="" />
							                </a>
							            </li>
							            <li class="mui-table-view-cell">
					                     	<span class="ka_proinfo lang" data-locale="commodity_price"></span>
					                     	<div class="mui-pull-right">
					                     		<input type="text" name="price" id="price" value="" placeholder="0" cla="ka_comdprice" maxlength="10" />
					                     		<span class="comd_login_unit">P</span>
					                     	</div>
					                     	
							            </li>
							        </ul>
							    </div><br />
							    <div class="ka_prologbox">
							    	 <h5 class="ka_proloh5 lang" data-locale="commodity_buyway"></h5>
							    	 <ul class="mui-table-view">
							    	         <li class="mui-table-view-cell">
							    	             <div class="ka_userbox">
								    	            <div class="mui-pull-left ka_exchangegrey lang" data-locale="commodity_switch" id="exchbuybtn"></div>
								    	            <input type="hidden" name="exchange" id="exchange" value="0" />
								    	            <div class="mui-pull-left ka_exchangegrey lang" data-locale="commodity_pointbuy" id="pointbuybtn"></div>
								    	             <input type="hidden" name="business" id="business" value="0" />
								    	             <div class="mui-pull-left ka_exchangegrey lang" data-locale="commodity_free" id="freebuybtn"></div>
								    	             <input type="hidden" name="gratis" id="gratis" value="0" />
							    	            </div>
							    	         </li>
							    	     </ul>
							    </div>
						</div><br/>
						<div class="ka_description lang" data-locale="commodity_forbidentext">
						</div>
						<div class="ka_userbox">
							<button type="button" class="mui-btn mui-btn-red ka_prologsure lang"  data-locale="commodity_buttonsure" onclick="publishs()"></button>
						</div>
						<br/>
						<div class="showimg">
				        </div>
				        <div id="deltimg" style="display: none;"></div>
				    </div>    
				</div>
			</form>
			</div>
    </div>
	 <!--productsataute page-->
	 	<div id="productstaute" class="mui-page">
			<div class="mui-navbar-inner mui-bar mui-bar-nav">
				<button type="button" class="mui-left mui-action-back mui-btn  mui-btn-link mui-btn-nav mui-pull-left">
					<span class="mui-icon mui-icon-left-nav"></span>
				</button>
				<h1 class="mui-center mui-title lang" data-locale="commodity_stuates"></h1>
			</div>
			<div class="mui-page-content">
				<div class="mui-scroll-wrapper">
					<div class="mui-scroll">
						<ul class="mui-table-view">
					        <li class="mui-table-view-cell">
					            <a class="mui-pull-left" onclick="foundstuat(this)">
					              	<span class="ka_sortfont">新品・未使用</span>
					              	 <input type="hidden" name="stuate0" id="stuate0" value="0" />
					            </a>
					        </li>
					        <li class="mui-table-view-cell">
					            <a class="mui-pull-left" onclick="foundstuat(this)">
					            	   <span class="ka_sortfont">未使用に近い</span>
					            	    <input type="hidden" name="stuate1" id="stuate1" value="1" />
					            </a>
					        </li>
					        <li class="mui-table-view-cell">
					            <a class="mui-pull-left" onclick="foundstuat(this)">
					             	  <span class="ka_sortfont">目立った傷や汚れなし</span>
					             	   <input type="hidden" name="stuate2" id="stuate2" value="2" />
					            </a>
					        </li>
					        <li class="mui-table-view-cell">
					            <a class="mui-pull-left" onclick="foundstuat(this)">
					             	  <span class="ka_sortfont">傷や汚れあり</span>
					             	  <input type="hidden" name="stuate3" id="stuate3" value="3" />
					            </a>
					        </li>
					        <li class="mui-table-view-cell">
					            <a class="mui-pull-left" onclick="foundstuat(this)">
					             	  <span class="ka_sortfont">全体的に状態が悪い)</span>
					             	   <input type="hidden" name="stuate4" id="stuate4" value="4" />
					            </a>
					        </li>
					    </ul>
					</div>
				</div>
			</div>
		</div>
	</body>
	<script src="../../../js/mui.min.js"></script>
	<script src="../../../js/mui.view.js "></script>
	<script src='../../../js/feedback.js'></script>
	<script src="../../../js/mui.picker.js"></script>
	<script src="../../../js/mui.poppicker.js"></script>
	<script src="../../../js/pro_loginsort.js" type="text/javascript" charset="utf-8"></script>
	<script src="../../../js/jquery-3.2.0.min.js"></script>
	<script src="../../../js/language.js"></script>
	<script src="../../../js/sha256.js"></script>
	<script src="../../../js/common.js"></script>
	<script src="../../../js/compress.js"></script>
	<script>
		$(function(){
			$(".ka_noborder").attr("placeholder",TextMessage.commodity_descriptionlength);
			mui.plusReady(function() {
			var param2={
				"flg":"commodity"
				};
			Repository.Commodity.category(param2, {
					ok: function(data) {
						Log.d("success");
						console.dir(data);
					},
					ng: function(data) {
						Log.d(data);
						if(data=="1000"){
							alert(TextMessage.test);
						}
					}
				});
			});
		});
		//sort 
		(function($, doc) {
				$.init();
				$.ready(function() {
					var cityPicker = new $.PopPicker({
						layer: 2
					});
					cityPicker.setData(cityData);
					var showCityPickerButton = doc.getElementById('showCityPicker');
					var cityResult = doc.getElementById('sortResult');
					showCityPickerButton.addEventListener('tap', function(event) {
						cityPicker.show(function(items) {
							cityResult.innerText =items[0].text + " " + items[1].text;
							document.getElementById("classify_id").value=items[1].value;
						});
						document.getElementById("bitian1").style.display="none";
					}, false);
					//-----------------------------------------
				});
			})(mui, document);
		var viewApi = mui('#app').view({
			defaultPage: '#productlogin'
		});
		mui('.mui-scroll-wrapper').scroll();
		var view = viewApi.view;
		(function($) {
			//view back and webviewback
			var oldBack = $.back;
			$.back = function() {
				if (viewApi.canBack()) { 
					//view back
					viewApi.back();
				} else { 
					//webview back
					oldBack();
				}
			};
			view.addEventListener('pageBeforeShow', function(e) {
				//				console.log(e.detail.page.id + ' beforeShow');
			});
			view.addEventListener('pageShow', function(e) {
				//				console.log(e.detail.page.id + ' show');
			});
			view.addEventListener('pageBeforeBack', function(e) {
				//				console.log(e.detail.page.id + ' beforeBack');
			});
			view.addEventListener('pageBack', function(e) {
				//				console.log(e.detail.page.id + ' back');
			});
		})(mui);
		
		function publishs(){
			//return confirm(TextMessage.publishsure);
			var buy_sell_flag="0";
			var comm_name=$("#comm_name").val();
			var comm_detail=$("#comm_detail").val();
			var classify_id=$("#classify_id").val();
			var comm_state=$("#comm_state").val();
			var exchange=$("#exchange").val();
			var business=$("#business").val();
			var gratis=$("#gratis").val();
			var imges0=$("#0").val();
			var imges1=$("#1").val();
			var imges2=$("#2").val();
			var imges3=$("#3").val();
			var price=$("#price").val();
			if(imges0=="0" & imges1=="0" & imges2=="0" & imges3=="0"){
				alert("请为商品至少选择一张图片！");
				return false;
			}
			if(comm_name==""){
				alert("商品名称不能为空！");
				document.publishcomodity.comm_name.focus();
				return false;
			}
			if(comm_detail==""){
				alert("商品描述不能为空！");
				document.publishcomodity.comm_detail.focus();
				return false;
			}
			if(classify_id==""){
				alert("请选择商品分类！");
				return false;
			}
			if(comm_state==""){
				alert("请选择商品状态！");
				return false;
			}
			if(price!=""){
				if(isNaN(price)){
					alert("价格只能是数字！");
					document.publishcomodity.price.focus();
					return false;
				}
				if(price<0){
					alert("价格必须大于或等于0！");
					document.publishcomodity.price.focus();
					return false;
				}
			}
			if(exchange=="0" & business=="0" & gratis=="0"){
				alert("请选择交易手段！");
				return false;
			}
			var params={
				"buy_sell_flag":buy_sell_flag,
				"comm_name":comm_name,
				"comm_detail":comm_detail,
				"classify_id":classify_id,
				"comm_state":comm_state,
				"exchange":exchange,
				"business":business,
				"gratis":gratis,
				"price":price,
				"imges[0]":imges0,
				"imges[1]":imges1,
				"imges[2]":imges2,
				"imges[3]":imges3
			};
			//console.dir(params);
			Repository.Commodity.Commoditypublish(params, {
					ok: function(data) {
						Log.d("success");
						alert("发布成功！");
						location.reload();
					},
					ng: function(data) {
						Log.d(data);
						if(data=="1000"){
							alert(TextMessage.test);
						}
					}
				});
			
		}
		//stuat value
		function foundstuat(e){
			var stuat=$(e).children("span").html();
			var stuatenumber=$(e).children("input").val()
			$("#prostuat div").html(stuat);
			$("#comm_state").val(stuatenumber);
			$("#prostuat div").removeClass("ka_bitian");
			$("#prostuat div").addClass("ka_sortname");
			$("#productstaute .ka_gaoliang").each(function(){
				$(this).removeClass("ka_gaoliang");
				$(this).addClass("ka_sortfont");
			});
			$(e).children("span").removeClass("ka_sortfont");
			$(e).children("span").addClass("ka_gaoliang");
		}
		///////////////take picture/////////////////
        mui(".ka_prologbox0").on("tap", "#takepic",function(e) {
				if(mui.os.plus){
					var a = [{
						title: TextMessage.tackpicture
					}];
					plus.nativeUI.actionSheet({
						title: TextMessage.comdity_takepic,
						cancel: TextMessage.cancel,
						buttons: a
					}, function(b) {
						switch (b.index) {
							case 0:
								break;
							case 1:
								getImage();
								break;
							default:
								break
						}
					})	
				}
				
			});
			//gallery
			mui(".ka_prologbox0").on("tap", "#gallery",function(e) {
				if(mui.os.plus){
					var a = [{
						title: TextMessage.gallerychoose
					}];
					plus.nativeUI.actionSheet({
						title: TextMessage.chooseimage,
						cancel: TextMessage.cancel,
						buttons: a
					}, function(b) {
						switch (b.index) {
							case 0:
								break;
							case 1:
								galleryImg();
								break;
							default:
								break
						}
					})	
				}
				
			});
		function imglength(){
			var imglength=$(".z_images").length;
			    if(imglength>3){
			    	$(".z_file").hide();
			    	$("#takepic").hide();
			    }
		}
	     //px Convert to rem
        (function(doc, win) {
            var docEl = doc.documentElement,
                resizeEvt = 'orientationchange' in window ? 'orientationchange' : 'resize',
                recalc = function() {
                    var clientWidth = docEl.clientWidth;
                    if (!clientWidth) return;
                    if (clientWidth >= 640) {
                        docEl.style.fontSize = '100px';
                    } else {
                        docEl.style.fontSize = 100 * (clientWidth / 640) + 'px';
                    }
                };

            if (!doc.addEventListener) return;
            win.addEventListener(resizeEvt, recalc, false);
            doc.addEventListener('DOMContentLoaded', recalc, false);
        })(document, window);
		//delete image
        function imgRemove() {
            var imgList = document.getElementsByClassName("z_addImg");
            var mask = document.getElementsByClassName("z_mask")[0];
            var cancel = document.getElementsByClassName("z_cancel")[0];
            var sure = document.getElementsByClassName("z_sure")[0];
            for (var j = 0; j < imgList.length; j++) {
                imgList[j].index = j;
                imgList[j].onclick = function() {
                    var t = this;
                    mask.style.display = "block";
                    cancel.onclick = function() {
                        mask.style.display = "none";
                    };
                    sure.onclick = function() {
                        mask.style.display = "none";
                        t.style.display = "none";
                        var picdisp=$(".z_file").css("display");
                        if(picdisp=="none"){
                        	$(".z_file").show();
                        }
                        var takpic=$("#takepic").css("display");
                        if(takpic=="none"){
                        	$("#takepic").show();
                        }
                        var dethtml=$(t).html();
                   		$("#deltimg").html(dethtml);
                   		var altval=$("#deltimg img").attr("alt");
                   		$("#"+altval).val("0");
                   		nums=altval;
                   		$(t).remove();
                   		$("#deltimg").empty();
                    };

                } 
            };
             
        };
        
			//compressImage
			function compressImg(path){
		        var currenttime=Date.parse(new Date());
				plus.zip.compressImage({
						src:path,
						dst:"_doc/"+currenttime+".jpg",
						quality:20,
						overwrite:true,
						format:"jpg"	
					},
					function(event) {
						console.log("Compress success!");
						var target = event.target; 
						var size = event.size; // （Byte）
						var width = event.width; // px
						var height = event.height; // px
						uploadimage(target);
					},function(error) {
						alert("Compress error!"+error.message);
				});
			}
			function uploadimage(path){
				var targetimg=path;
				var server = "http://192.168.1.8:7998/commodity/release/upload/";
                    //open loading button
                    var wt=plus.nativeUI.showWaiting();
                    var task = plus.uploader.createUpload(server, {  
                        method: "post"  
                    }, function(t, status) {  
                        if(status == 200) { 
                           console.log("upload success:"+t.responseText);
                           Processing(t.responseText);
                           wt.close(); 
                        }else{
                            console.log("upload error："+status);
                            wt.close();
                        }
                    });  
                    //add parameter
                    task.addData("tokencheck","+GGzMiM28W8dy+XxzQAl4x3L5fHNACXjh/PqKa19BIs=70760a3f4cbcc375c67df5c75919adbe09b8aca4fc25fa6d7068bcd66169a108");
                    task.addData("signcheck","1493287721102_49389b1a23ee8666d3a8c67c8f77ff4710c6d5b57828d3f7e9072bb435224a82_ee1eb2312fdfef2ae95820e306f93a6b4696772182f9dcbdd44d406d7cff379c");
                    task.addData("serial",nums.toString());
                    task.addFile(targetimg, {key:"image"});  
                    task.start(); 
			}
			function Processing(results){
				var data=JSON.parse(results);
				var stautes=data.result.status;
				console.log(stautes);
				if(stautes=="OK"){
					var imagesrc=data.result.data[1];
					var value=$("#"+nums).val();
					if(value=="0"){
						$("#"+nums).val(imagesrc);
					}
				}else{
					alert("image error:"+data.result.statuscode.image);
				}
			}
			var nums=0;
			function imgappend(localurl){
				var flag=true;
				for(var m=0;m<4;m++){
                	var valuem=$("#"+m).val();
					if(valuem=="0"){
						nums=m;
						break;
					}
            	}
				var img = document.createElement("img");
                img.setAttribute("src",localurl);
                img.setAttribute("alt",nums);
                img.setAttribute("class","z_images");
                var imgAdd = document.createElement("div");
                imgAdd.setAttribute("class", "z_addImg");
                imgAdd.appendChild(img);
                $(".z_photo").append(imgAdd);
			}
			function getImage() {
				var c = plus.camera.getCamera();
				c.captureImage(function(e) {
					plus.io.resolveLocalFileSystemURL(e, function(entry) {
						var localurl = entry.toLocalURL();
						imgappend(localurl);
		                 imglength();
		                 imgRemove();
		                 compressImg(localurl);
					}, function(e) {
						console.log("Read the picture file error：" + e.message);
					});
				}, function(s) {
					console.log("error" + s);
				}, {
					filename: "_doc/camera/"
				})
			}
			function galleryImg() {
			plus.gallery.pick(function(a) {
				plus.io.resolveLocalFileSystemURL(a, function(entry) {
					var localURL2 = entry.toLocalURL();
					imgappend(localURL2);
	                 imglength();
	                 imgRemove();
	                 compressImg(localURL2);
						
				}, function(e) {
					console.log("Read photo file error：" + e.message);
				});
			}, function(a) {}, {
				filter: "image"
			})
		};
		//buy way choose
		/*exchange*/
		document.getElementById('exchbuybtn').addEventListener('tap',function(e){
			$("#exchange").val("1");
			$("#exchbuybtn").removeClass("ka_exchangegrey");
			$("#exchbuybtn").addClass("ka_exchangered");
			if($("#gratis").val()=="1"){
				$("#gratis").val("0");
				$("#freebuybtn").removeClass("ka_exchangered");
				$("#freebuybtn").addClass("ka_exchangegrey");
			}
		});
		/*point*/
		document.getElementById('pointbuybtn').addEventListener('tap',function(e){
			$("#business").val("1");
			$("#pointbuybtn").removeClass("ka_exchangegrey");
			$("#pointbuybtn").addClass("ka_exchangered");
			if($("#gratis").val()=="1"){
				$("#gratis").val("0");
				$("#freebuybtn").removeClass("ka_exchangered");
				$("#freebuybtn").addClass("ka_exchangegrey");
			}
		});
		/*free*/
		document.getElementById('freebuybtn').addEventListener('tap',function(e){
			$("#gratis").val("1");
			$("#freebuybtn").removeClass("ka_exchangegrey");
			$("#freebuybtn").addClass("ka_exchangered");
			if($("#business").val()=="1"){
				$("#business").val("0");
				$("#pointbuybtn").removeClass("ka_exchangered");
				$("#pointbuybtn").addClass("ka_exchangegrey");
			}
			if($("#exchange").val()=="1"){
				$("#exchange").val("0");
				$("#exchbuybtn").removeClass("ka_exchangered");
				$("#exchbuybtn").addClass("ka_exchangegrey");
			}
		});
	</script>

</html>