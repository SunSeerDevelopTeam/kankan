<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../../../css/mui.min.css" rel="stylesheet" />
		<link href="../../../css/kankan_home.css" rel="stylesheet" />
		<style>
			html,
			body {
				background-color: #efeff4;
			}
			
			.mui-bar~.mui-content .mui-fullscreen {
				top: 44px;
				height: auto;
			}
			
			.mui-pull-top-tips {
				position: absolute;
				top: -20px;
				left: 50%;
				margin-left: -25px;
				width: 40px;
				height: 40px;
				border-radius: 100%;
				z-index: 999;
			}
			
			.mui-bar~.mui-pull-top-tips {
				top: 24px;
			}
			
			.mui-pull-top-wrapper {
				width: 42px;
				height: 42px;
				display: block;
				text-align: center;
				background-color: #efeff4;
				border: 1px solid #ddd;
				border-radius: 25px;
				background-clip: padding-box;
				box-shadow: 0 4px 10px #bbb;
				overflow: hidden;
			}
			
			.mui-pull-top-tips.mui-transitioning {
				-webkit-transition-duration: 200ms;
				transition-duration: 200ms;
			}
			
			.mui-pull-top-tips .mui-pull-loading {
				/*-webkit-backface-visibility: hidden;
				-webkit-transition-duration: 400ms;
				transition-duration: 400ms;*/
				margin: 0;
			}
			
			.mui-pull-top-wrapper .mui-icon,
			.mui-pull-top-wrapper .mui-spinner {
				margin-top: 7px;
			}
			
			.mui-pull-top-wrapper .mui-icon.mui-reverse {
				/*-webkit-transform: rotate(180deg) translateZ(0);*/
			}
			
			.mui-pull-bottom-tips {
				text-align: center;
				background-color: #efeff4;
				font-size: 15px;
				line-height: 40px;
				color: #777;
			}
			
			.mui-pull-top-canvas {
				overflow: hidden;
				background-color: #fafafa;
				border-radius: 40px;
				box-shadow: 0 4px 10px #bbb;
				width: 40px;
				height: 40px;
				margin: 0 auto;
			}
			
			.mui-pull-top-canvas canvas {
				width: 40px;
			}
			
			.mui-slider-indicator.mui-segmented-control {
				background-color: #efeff4;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<h1 class="mui-title lang" data-locale="requesttitle"></h1>
			<div id="history">
				<a class="mui-icon mui-icon  mui-icon-right-nav mui-pull-right jiaoyihitext"><span style="font-size: 14px;" class="lang" data-locale="thistorytext"></span></a>
			</div>
		</header>
		<div id="reloadpage" onclick="reloadpage()" style="display: none;">
			<font size="2" class="lang" data-locale="networkerror"></font>
		</div>
		<div class="mui-content">
			<div id="slider" class="mui-slider mui-fullscreen">
				<div id="sliderSegmentedControl" class="mui-scroll-wrapper mui-slider-indicator mui-segmented-control mui-segmented-control-inverted">
					<div class="mui-scroll" style="width: 100%;">
						<a class="mui-control-item mui-active lang" href="#item1mobile" style="width: 50%;" data-locale="requestedpro">
						</a>
						<a class="mui-control-item lang" href="#item2mobile" style="width: 50%;" data-locale="requestpro">
						</a>
					</div>
				</div>
				<div class="mui-slider-group">
					<div id="item1mobile" class="mui-slider-item mui-control-content mui-active">
						<div id="scroll1" class="mui-scroll-wrapper">
							<div class="mui-scroll">
								<ul class="mui-table-view mui-grid-view want-sell" id="requested" style="margin-top: 2em;">
								</ul>
							</div>
						</div>
					</div>
					<div id="item2mobile" class="mui-slider-item mui-control-content">
						<div class="mui-scroll-wrapper">
							<div class="mui-scroll">
								<ul class="mui-table-view mui-grid-view want-sell" id="request" style="margin-top: 2em;">
								</ul>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<script src="../../../js/common.js"></script>
		<script src="../../../js/mui.min.js"></script>
		<script src="../../../js/mui.pullToRefresh.js"></script>
		<script src="../../../js/mui.pullToRefresh.material.js"></script>
		<script src="../../../js/jquery-3.2.0.min.js"></script>
		<script src="../../../js/language.js"></script>
		<script src="../../../js/sha256.js"></script>
		<script type="text/javascript">
			mui.init();
			var imgwidth = parseInt($(window).width()) / 3 - 17;
			var transpro = "";
			var otranspro = "";
			var requestpage = 0;
			var requestedpage = 0;

			function reloadpage() {
				location.reload();
			}
			window.addEventListener('requestpage', function(event) {
				self.location.reload();

			});
			mui.plusReady(function() {
				getdata("down","all");
			});
			function getdata(flag,index){
				$(".mui-pull-loading").html(TextMessage.loading);
				if(index==0){
					//requested
					var data_flg=2;
					if(flag=="down"){
						var pages=0;
						requestedpage=1;
					}else{
						var pages=requestedpage;
						requestedpage++;
					}
				} else if(index == 1) {
					//request
					var data_flg = 1;
					if(flag == "down") {
						var pages = 0;
						requestpage = 1;
					} else {
						var pages = requestpage;
						requestpage++;
					}
				} else {
					//all
					var data_flg = 3;
					var pages = 0;
					requestpage = 1;
					requestedpage = 1;

				}
				mui.plusReady(function() {
					mui('#history').on('tap', 'a', function(e) {
						mui.openWindow({
							id: 'requestlist',
							url: "requestlist.html"
						});
					});
					var params = {
						"data_flg": data_flg,
						"page_num": pages
					};
					var myid = plus.storage.getItem("myid");
					if (myid != null && myid != "") {
						Repository.User.Usertranslist(params, {
							ok: function(data) {
								console.log("request success");
								showcommodity(flag, index, pages, data);
								clicktrans();
							},
							ng: function(data) {
								console.log(data);
								Api.callback_ng(data);
							},
							error: function() {
								$("#reloadpage").show();
								$(".mui-content").hide();
								$(".jiaoyihitext").hide();
							}
						});
					}
				});
			}

			function clicktrans() {
				var translatepage = null;
				mui('.translate').on('tap', 'a', function(e) {
					var tid = this.getAttribute('id');
					//var curView = plus.webview.currentWebview();
					//plus.webview.close(curView);
					mui.openWindow({
						url: "../../transaction/transaction2.html?transid=" + tid,
						id: "transaction",
						extras: {
							"transid": tid
						}
					});
				});
			}

			function showcommodity(flag, index, page, results) {
				var data = results.data;
				var myid = results.myid;
				var htmlnull = '<div style="text-align: center;"><p>' + TextMessage.datanull + '</p></div>';
				var others = data.own;
				if(others) {
					var otlength = others.length;
				} else {
					var otlength = 0;
				}

				if(index == "0" || index == "all") {
					//requested
					if(others == "" || otlength <= 10 || data == "") {
						$("#item1mobile .mui-pull-loading").html(TextMessage.nomore);
					}
					if(flag == "down") {
						$("#requested").empty();
					}
					for(var ot = 0; ot < otlength; ot++) {
						var transid = others[ot].trans.trans_id;
						var comditylength = others[ot].trans.commodity.length;
						for(var vi = 0; vi < comditylength; vi++) {
							if(others[ot].trans.commodity[vi].comm_user_id == myid) {
								transpro = others[ot].trans.commodity[vi];
								break;
							}
						}
						var comm_name = HTMLDecode(transpro.comm_name);
						var comm_img = transpro.comm_img;
						var trans_type = others[ot].trans.trans_type;
						if(trans_type == "0") {
							var trans_typetext = TextMessage.requireing;
						} else {
							var trans_typetext = TextMessage.requresuces;
						}
						var status = others[ot].trans.status;
						var other_photo = others[ot].trans.other_photo;
						var my_photo = others[ot].trans.my_photo;
						var price = others[ot].trans.price;
						var trans_mode = others[ot].trans.trans_mode;
						var transprocount = others[ot].trans.trans_comm_nums;
						var realwidth = transpro.comm_img_width;
						var realheight = transpro.comm_img_height;
						var toppx = 0;
						var oribi = realheight / realwidth;
						var showheight = imgwidth * oribi;
						var cha1 = showheight - imgwidth;
						if(cha1 > 0) {
							toppx = (cha1 / 2) * (-1);
						} else {
							toppx = 0;
						}
						var html = new Util.StringBuilder();
						html.appendFormat('<li class="mui-table-view-cell mui-media mui-col-xs-4 translate"><a id="{0}" href="#">', transid)
							.appendFormat('<div class="ka_imgoption" style="height:{0}px;text-align:center;"><img class="mui-media-object" src="{1}" style="height: auto;width:100%;margin-top:{2}px;" onerror="this.src=' + "'../../../images/nopic.jpg'" + '"></div>', imgwidth, comm_img == "" ? "../../../images/nopic.jpg" : comm_img, toppx)
							.appendFormat('<div class="mui-media-body">{0}</div>', comm_name)
							.appendFormat('</a><div class="{0}">{1}</div>', trans_type == 0 ? "kankan_jyz" : "kankan_jycl", trans_typetext)
							.appendFormat('<div class="kankan_morecoin"><img src="../../../images/morebut.png" style="width: 25px; height: 25px;display:{0};"></div>', transprocount > 1 ? "" : "none")
							.appendFormat('<div class="mui-pull-left kankan_jyimgbox"><img src="{0}" style="border-radius: 50%; width: 20px; height: 20px;">', my_photo == "" ? "../../../images/userPhoto.png" : my_photo)
							.appendFormat('<img src="../../../images/jiantou.png" class="kankan_jhjiantou"><img src="{0}" style="border-radius: 50%; width: 20px; height: 20px;"></div></li>', other_photo == "" ? "../../../images/userPhoto.png" : other_photo)
						//.appendFormat('<div class="mui-pull-left ka_mony"><div>{0}<font color="#000000"> P</font></div></div></li>',price);
						$("#requested").append(html.toString());
					}
				}
				if(index == "1" || index == "all") {
					//request
					if(flag == "down") {
						$("#request").empty();
					}
					var own = data.other;
					if(own) {
						var owlength = own.length;
					} else {
						var owlength = 0;
					}
					if(own == "" || owlength <= 10 || data == "") {
						$("#item2mobile .mui-pull-loading").html(TextMessage.nomore);
					}
					for(var ow = 0; ow < owlength; ow++) {
						var otransid = own[ow].trans.trans_id;
						var ocomditylength = own[ow].trans.commodity.length;
						for(var wi = 0; wi < ocomditylength; wi++) {
							if(own[ow].trans.commodity[wi].comm_user_id != myid) {
								var otranspro = own[ow].trans.commodity[wi];
								break;
							}
						}
						var ocomm_name = otranspro.comm_name;
						var ocomm_img = otranspro.comm_img;
						if(otranspro.comm_img == "") {
							var ocomm_img = "../../../images/nopic.jpg";
						}
						var otrans_type = own[ow].trans.trans_type;
						if(otrans_type == "0") {
							var otrans_typetext = TextMessage.requireing;
						} else {
							var otrans_typetext = TextMessage.requresuces;
						}
						var ostatus = own[ow].trans.status;
						var oother_photo = own[ow].trans.other_photo;
						var omy_photo = own[ow].trans.my_photo;
						if(own[ow].trans.my_photo == "") {
							var omy_photo = "../../../images/userPhoto.png";
						}
						if(own[ow].trans.other_photo == "") {
							var oother_photo = "../../../images/userPhoto.png";
						}
						var oprice = own[ow].trans.price;
						var otrans_mode = own[ow].trans.trans_mode;
						var otransprocount = own[ow].trans.trans_comm_nums;
						var orealwidth = otranspro.comm_img_width;
						var orealheight = otranspro.comm_img_height;
						var otoppx = 0;
						var ooribi = orealheight / orealwidth;
						var oshowheight = imgwidth * ooribi;
						var cha2 = oshowheight - imgwidth;
						if(cha2 > 0) {
							otoppx = (cha2 / 2) * (-1);
						}
						var html2 = new Util.StringBuilder();
						html2.appendFormat('<li class="mui-table-view-cell mui-media mui-col-xs-4 translate"><a id="{0}" href="#">', otransid)
							.appendFormat('<div class="ka_imgoption" style="height:{0}px;text-align:center;"><img class="mui-media-object" src="{1}" style="height: auto;width:100%;margin-top:{2}px;" onerror="this.src=' + "'../../../images/nopic.jpg'" + '"></div>', imgwidth, ocomm_img == "" ? "../../../images/nopic.jpg" : ocomm_img, otoppx)
							.appendFormat('<div class="mui-media-body">{0}</div>', ocomm_name)
							.appendFormat('</a><div class="{0}">{1}</div>', otrans_type == 0 ? "kankan_jyz" : "kankan_jycl", otrans_typetext)
							.appendFormat('<div class="kankan_morecoin"><img src="../../../images/morebut.png" style="width: 25px; height: 25px;display:{0};"></div>', otransprocount > 1 ? "" : "none")
							.appendFormat('<div class="mui-pull-left kankan_jyimgbox"><img src="{0}" style="border-radius: 50%; width: 20px; height: 20px;">', omy_photo == "" ? "../../../images/userPhoto.png" : omy_photo)
							.appendFormat('<img src="../../../images/jiantou.png" class="kankan_jhjiantou"><img src="{0}" style="border-radius: 50%; width: 20px; height: 20px;"></div></li>', oother_photo == "" ? "../../../images/userPhoto.png" : oother_photo)
						//.appendFormat('<div class="mui-pull-left ka_mony"><div>{0}<font color="#000000"> P</font></div></div></li>',oprice);
						$("#request").append(html2.toString());
					}
				}
			}
			(function($) {
				//阻尼系数
				var deceleration = mui.os.ios ? 0.003 : 0.0009;
				$('.mui-scroll-wrapper').scroll({
					bounce: false,
					indicators: true, //是否显示滚动条
					deceleration: deceleration
				});
				$.ready(function() {
					$.each(document.querySelectorAll('.mui-slider-group .mui-scroll'), function(index, pullRefreshEl) {
						$(pullRefreshEl).pullToRefresh({
							down: {
								callback: function() {
									var self = this;
									setTimeout(function() {
										var ul = self.element.querySelector('.mui-table-view');
										//ul.insertBefore(createFragment(ul, index, 10, true), ul.firstChild);
										getdata("down", index);
										self.endPullDownToRefresh();
									}, 1000);
								}
							},
							up: {
								callback: function() {
									var self = this;
									setTimeout(function() {
										var ul = self.element.querySelector('.mui-table-view');
										getdata("up", index);
										//ul.appendChild(createFragment(ul, index, 5));
										self.endPullUpToRefresh();
									}, 1000);
								}
							}
						});
					});
					//					var createFragment = function(ul, index, count, reverse) {
					//						alert(reverse);
					//						var length = ul.querySelectorAll('li').length;
					//						var fragment = document.createDocumentFragment();
					//						var li;
					//						for (var i = 0; i < count; i++) {
					//							li = document.createElement('li');
					//							li.className = 'mui-table-view-cell';
					//							li.innerHTML = '第' + (index + 1) + '个选项卡子项-' + (length + (reverse ? (count - i) : (i + 1)));
					//							fragment.appendChild(li);
					//						}
					//						return fragment;
					//					};
				});
			})(mui);
		</script>
	</body>

</html>