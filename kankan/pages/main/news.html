<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>news</title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" href="../../css/kankan_home.css" />
		<style>
			.message{
				text-align: left;padding:10px 28px 10px 15px;width: 100%;word-wrap: break-word;
				font-size: 14px;
			}
			.newsbox{
				float:right;margin-right: -28px;
			}
			.lines{
				border: 0.06em #cccccc solid;
			}
			.newsb{
				background-color: #FFFFFF; 
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
		    <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
		    <h1 class="mui-title lang" data-locale="messagetitle">站内信一览</h1>
		</header>
		<div id="pullrefresh" class="mui-content mui-scroll-wrapper">
  			<div class="mui-scroll">
				<ul id="OA_task_1" class="mui-table-view">
				<!--<li class="mui-table-view-cell">
					<div class="mui-slider-right mui-disabled">
						<a class="mui-btn mui-btn-red">删除</a>
					</div>
					<div class="mui-slider-handle">
						左滑显示删除按钮
					</div>
				</li>-->
				</ul>
			</div>
		</div>
		<script src="../../js/mui.min.js"></script>
		<script src="../../js/jquery-3.2.0.min.js"></script>
		<script src="../../js/language.js"></script>
		<script src="../../js/sha256.js"></script>
		<script src="../../js/common.js"></script>
		<script type="text/javascript">
			var count = 0;
			var page="";
			var max=10;
			 mui.init({
			    pullRefresh: 
			    {
			      container: '#pullrefresh',
			      down: {
			        callback: pullupRefresh
			      },
			      up: {
			        contentrefresh: TextMessage.loading,
			        contentnomore:TextMessage.nomore,
			        contentinit: TextMessage.upmore,
			        contentdown:TextMessage.upmore,
			        callback: pullupRefresh
			      }
			    },
			    beforeback: function() {
			        var homePage = plus.webview.getWebviewById('pullrefresh_with_tab');
					mui.fire(homePage, 'refresh',{refresh:"canRefresh"});
			    }
		  });  
		  //delete message
		  (function($) {
		  	var btnArray = [TextMessage.sure, TextMessage.cancel];
			$('#OA_task_1').on('tap', '.mui-btn', function(event) {
				
				var elem = this;
				var li = elem.parentNode.parentNode;
				mui.confirm(TextMessage.delmessage, TextMessage.sharetitle, btnArray, function(e) {
					if (e.index == 0) {
						li.parentNode.removeChild(li);
						console.log(li.getAttribute("id"));
						var mid=li.getAttribute("id");
						var parms3={
							"msg_ids":mid,
						};
						Repository.User.del_message(parms3, {
						ok: function(data) {
							console.log(data);
							console.log("delete success!");
						},
						ng: function(data) {
							/*console.log(data);
							if(data=="1000"){
								mui.toast(TextMessage.test, {
									duration: 'long',
									type: 'div'
								})
							}*/
							Api.callback_ng(data);
						},
					});
					} else {
						setTimeout(function() {
							$.swipeoutClose(li);
						}, 0);
					}
				});
			});
				
		  })(mui)
			//show message
			function showmessage(results){
				if(results.data.message==""){
					mui('#pullrefresh').pullRefresh().endPullupToRefresh(true);
				}
				var messarr=results.data.message;
				page=results.data.page.page;
				count=results.data.page.cnt;
				max=results.data.page.max;
				var num=page*max;
				var htmls='';
				for(var j=0; j<messarr.length;j++){
					var mess=messarr[j].message;
					var mesid=messarr[j].msg_id;
				      mui('#pullrefresh').pullRefresh().endPullupToRefresh((num >= count)); //参数为true代表没有更多数据了。
				      var table = document.body.querySelector('#OA_task_1');
				      var cells = document.body.querySelectorAll('.mui-table-view');
			        var li = document.createElement('li');
			        li.className = 'mui-table-view-cell';
			        li.id=mesid;
			        li.innerHTML = '<div class="mui-slider-right mui-disabled"><a class="mui-btn mui-btn-red">删除</a></div><div class="mui-slider-handle">'+mess+'</div>';
			        table.appendChild(li);
				}
				page=page+1;
				//$(".mui-pull-caption-down").hide();
			}
		  //load
		  function pullupRefresh() 
		  {
		  	getmessage(page);
			//get message
			function getmessage(page){
			  	mui.plusReady(function() {
				  	var params2={};
					if(max!=null){
						params2.max=max;
					}
					if(page!=null){
						params2.page=page;
					}
					Repository.User.get_message(params2, {
						ok: function(data) {
							console.log(data);
							showmessage(data);
						},
						ng: function(data) {
							/*console.log(data);
							if(data=="1000"){
								mui.toast(TextMessage.test, {
									duration: 'long',
									type: 'div'
								})
							}*/
							Api.callback_ng(data);
						},
					});
				});
			}
			
//		    setTimeout(function() {
//		      mui('#pullrefresh').pullRefresh().endPullupToRefresh((++count > 2)); //参数为true代表没有更多数据了。
//		      var table = document.body.querySelector('.messagelist');
//		      var cells = document.body.querySelectorAll('.newsb');
//		      
//		      for (var i = cells.length, len = i + 5; i < len; i++) {
//		        var div = document.createElement('div');
//		        div.className = 'newsb';
//		        div.innerHTML = '<div class="message">你有新的短消息，请查看请查看请查看请查看查看<div class="newsbox"> <img src="../../images/clear.png"  width="25" height="25"/></div></div><div class="lines"></div>';
//		        table.appendChild(div);
//		      }
//		      
//		    }, 1500);
		  }    
		 if (mui.os.plus) {
		    mui.plusReady(function() {
		      setTimeout(function() {
		        mui('#pullrefresh').pullRefresh().pullupLoading();
		      }, 1000);
		
		    });
		 } else { 
		    mui.ready(function() {
		      mui('#pullrefresh').pullRefresh().pullupLoading();
		    });
		 }
		//update message staute
	mui.plusReady(function(){
		var params={};
		Repository.User.set_message(params, {
			ok: function(data) {
				console.log(data);
			},
			ng: function(data) {
				/*console.log(data);
				if(data=="1000"){
					mui.toast(TextMessage.test, {
						duration: 'long',
						type: 'div'
					})
				}*/
				Api.callback_ng(data);
			},
		});
		//getmessage("1");
		
		
		
		
	});
		</script>
	</body>

</html>