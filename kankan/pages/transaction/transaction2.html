<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>translatelist</title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link rel="stylesheet" href="../../css/mui.min.css" />
		<link href="../../css/icons-extra.css" rel="stylesheet" />
		<script src="../../jquery-3.2.0.min.js"></script>
		<style>
			html,
			body {
				background-color: #efeff4;
			}
		</style>
		<link rel="stylesheet" type="text/css" href="../../css/feedback.css" />
		<link rel="stylesheet" href="../../css/kankan_home.css">
		<link href="../../css/wu.css" rel="stylesheet" />
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left">
				<font size="3" class="lang" data-locale="back"></font>
			</a>
			<h1 class="mui-title"><span class="lang" data-locale="transaction"></span></h1>
		</header>
		<div class="mui-content">
			<div id="mui-page-content">
				<div class="tran-page">
					<div class="tran-body" style="margin-bottom:60px;">
						<div class="tran-name-middle-status mui-center">
							<font size="2" color="#ffffff" vertical-align="middle"></font>
						</div>
						<ul class="mui-table-view mui-grid-view exchange" style="display:none;margin-top:0px;position: inherit;padding:0 10px 10px 10px">
							<li class="mui-table-view-cell mui-media mui-col-xs-5 cur-user">

							</li>
							<li class="tran-pic-middle" style="margin-left:10px;">
								<img height="24px" width="24px" src="../../images/xinhuan.png" />
							</li>
							<li class="mui-table-view-cell mui-media mui-col-xs-5 request-user">

							</li>
						</ul>
						<ul class="mui-table-view mui-grid-view other" style="display:none;text-align:center;margin-top:0px;position: inherit;padding:0 10px 10px 10px">
							<li class="mui-table-view-cell mui-media mui-col-xs-5">

							</li>
						</ul>
						<ul class="tran-button">
							<li class="tran-button-sell">
								<div>
									<font size="2" vertical-align="middle" onclick="stopTransaction();">交易中止</font>
								</div>
							</li>
							<li class="tran-button-middle">
							</li>
							<li class="tran-button-buy">
								<div>
									<font size="2" color="#FFFFF" vertical-align="middle"></font>
								</div>
							</li>
						</ul>
						<input type="hidden" id="trans_status" name="trans_status" value="" />
						<input type="hidden" id="trans_mode" name="trans_mode" value="" />
						<input type="hidden" id="trans_type" name="trans_type" value="" />
						<input type="hidden" id="buyer_flag" name="buyer_flag" value="" />
						<input type="hidden" id="trans_deliver" name="trans_deliver" value="" />
						<input type="hidden" id="buyer_deliver" name="buyer_deliver" value="" />
						<input type="hidden" id="buyer_urge_r" name="buyer_urge_r" value="" />
						<input type="hidden" id="buyer_urge_d" name="buyer_urge_d" value="" />
						<input type="hidden" id="buyer_receipt" name="buyer_receipt" value="" />
						<input type="hidden" id="seller_deliver" name="seller_deliver" value="" />
						<input type="hidden" id="seller_urge_r" name="seller_urge_r" value="" />
						<input type="hidden" id="seller_urge_d" name="seller_urge_d" value="" />
						<input type="hidden" id="seller_receipt" name="seller_receipt" value="" />
						<!--<ul class="tran-distribution change_price" style="display:none;" onclick="change_price();">
							<li class="tran-distribution-law">
								<a href="../main/logisticslist.html">
									<div class="tran-distribution-call">
										<font size="2" color="#FFFFF" vertical-align="middle">改价</font>
										</font>
									</div>
								</a>
							</li>
						</ul>-->
						<ul class="tran-distribution">
							<li class="tran-distribution-law">
								<div class="tran-distribution-law-detail">
									<a href="#tradeLaw">
										<font size="3" class="lang" color="999999" data-locale="trans_criterion" vertical-align="middle"></font>
									</a>
								</div>
								<a href="../main/logisticslist.html">
									<div class="tran-distribution-call">
										<font size="2" class="lang" color="#FFFFF" data-locale="trans_logistic" vertical-align="middle"></font>
									</div>
								</a>
							</li>
						</ul>
						<ul id="msgArea" class="tran-chat">
						</ul>
					</div>
				</div>
			</div>
		</div>
		<nav class="mui-bar mui-bar-tab">
			<ul class="tran-foot">
				<li class="tran-foot-input">
					<input id="msg" type="text" value="" />
				</li>
				<li class="tran-foot-submit">
					<button type="button" onclick="submitChat();" class="mui-btn-link mui-btn-nav mui-pull-left">
						<span><font size="4" class="lang"  data-locale="send_mail"></font></span>
					</button>
				</li>
			</ul>
		</nav>
		<script type="text/javascript" src="../../js/mui.min.js"></script>
		<script type="text/javascript" src="../../js/jquery-3.2.0.min.js"></script>
		<script type="text/javascript" src="../../js/language.js"></script>
		<script type="text/javascript" src="../../js/sha256.js"></script>
		<script type="text/javascript" src="../../js/common.js"></script>
		<script type="text/javascript" charset="utf-8">
			mui.init();
			var trans_id;
			mui.plusReady(function() {
				mui.preload({
					id: 'detail',
					url: '../main/products/detail.html'
				});
				var self = plus.webview.currentWebview();
				trans_id = self.transid;
				var preView = plus.webview.getWebviewById('requestlist');
				plus.webview.close(preView);
				showRequestDetail();
			})
			//setInterval(showRequestDetail, 10000, "");
			function submitChat() {
				var chatMsg = $("#msg").val();
				if(chatMsg == '') {
					mui.toast(TextMessage.transContact);
					$("#msg").focus();
				} else {
					var params = {
						"message": chatMsg,
						"transid": trans_id
					};
					trans_flow('transConversation', params,'');
				}
			}

			function showRequestDetail() {
				var params = {
					"transid": trans_id
				};
				trans_flow('transEdite', params,'');
			}

			function getTransStatus(status) {
				var tranStatusVal = TRANS_STATUS[status];
				return tranStatusVal;
			}

			function setHidVal(transinfo, usersinfo, cur_user_id) {
				var buyer_id = transinfo[0].issue_user_id;
				var seller_id = transinfo[0].accept_user_id;
				var trans_mode = transinfo[0].trans_mode;
				var trans_status = transinfo[0].status;
				var trans_deliver = transinfo[0].deliver;
				var trans_type = transinfo[0].trans_type;
				var buyer_deliver, seller_deliver, buyer_urge_r, seller_urge_r, buyer_urge_d, seller_urge_d, buyer_receipt, seller_receipt;

				for(var u in usersinfo) {
					if(usersinfo[u].user_id == buyer_id) {
						buyer_deliver = usersinfo[u].deliver_flag;
						buyer_urge_r = usersinfo[u].urge_r_flag;
						buyer_urge_d = usersinfo[u].urge_d_flag;
						buyer_receipt = usersinfo[u].receipt_flag;
					} else {
						seller_deliver = usersinfo[u].deliver_flag;
						seller_urge_r = usersinfo[u].urge_r_flag;
						seller_urge_d = usersinfo[u].urge_d_flag;
						seller_receipt = usersinfo[u].receipt_flag;
					}
				}
				var buyer_flag = false;
				if(buyer_id == cur_user_id) buyer_flag = true;
				$("#trans_status").val(trans_status);
				$("#trans_mode").val(trans_mode);
				$("#trans_deliver").val(trans_deliver);
				$("#buyer_flag").val(buyer_flag);
				$("#trans_type").val(trans_type);
				$("#buyer_deliver").val(buyer_deliver);
				$("#buyer_urge_r").val(buyer_urge_r);
				$("#buyer_urge_d").val(buyer_urge_d);
				$("#buyer_receipt").val(buyer_receipt);
				$("#seller_deliver").val(seller_deliver);
				$("#seller_urge_r").val(seller_urge_r);
				$("#seller_urge_d").val(seller_urge_d);
				$("#seller_receipt").val(seller_receipt);
			}

			function showTranCommodMsg(transinfo, usersinfo, commdinfo, cur_user_id) {
				var buyer_photo, buyer_nickname, buyer_id, seller_photo, seller_nickname, seller_id, trans_mode, buyer_msg = '',
					seller_msg = '';
				var buyer_comm_info = new Array();
				var seller_comm_info = new Array();
				for(var user in usersinfo) {
					if(usersinfo[user].user_role == "issue") {
						buyer_photo = usersinfo[user].photo;
						buyer_nickname = usersinfo[user].nick_name;
						buyer_id = usersinfo[user].user_id;
					} else if(usersinfo[user].user_role == 'accept') {
						seller_photo = usersinfo[user].photo;
						seller_nickname = usersinfo[user].nick_name;
						seller_id = usersinfo[user].user_id;
					}
				}
				var buyer_comm_id, buyer_comm_img, buyer_comm_name, seller_comm_id, seller_comm_id, seller_comm_name;
				var seller_comm_exist = false;
				for(var goods in commdinfo) {
					if(commdinfo[goods].user_id == buyer_id) {
						buyer_comm_id = commdinfo[goods].commodity_id;
						buyer_comm_img = commdinfo[goods].img_flg;
						buyer_comm_name = commdinfo[goods].comm_name;
						buyer_comm_info.push(commdinfo[goods]);
					} else {
						seller_comm_exist = true;
						seller_comm_id = commdinfo[goods].commodity_id;
						seller_comm_img = commdinfo[goods].img_flg;
						seller_comm_name = commdinfo[goods].comm_name;
						seller_comm_info.push(commdinfo[goods]);
					}
				}

				var buyer_flag = false;
				if(cur_user_id == buyer_id) buyer_flag = true;
				var trans_mode = transinfo[0].trans_mode;
				if(trans_mode == 0) {
					if(seller_comm_exist) {
						seller_msg += '<a href="#">';
						seller_msg += '<div class="mui-media-body" style="height:35px;margin-top:0px;">';
						seller_msg += '<font size="2" vertical-align="middle">' + seller_nickname + '</font>';
						seller_msg += '</div>';
						if(seller_comm_info.length > 1) {
							seller_msg += '<img src="../../images/morebut.png" style="position:absolute;float:right;margin-left:72%;width: 25px; height: 25px;">';
						}
						seller_msg += '<img style="height:85px;width:128px;" class="mui-media-object" src="' + seller_comm_img + '" onerror="this.src=' + "'../../images/nopic.jpg'" + '">';
						seller_msg += '</a>';
						seller_msg += '<input type="hidden" name="seller_commodity_id" value="' + seller_comm_id + '">';
						seller_msg += '<input type="hidden" name="seller_user_id" value="' + seller_id + '">';
					}
					buyer_msg += '<a href="#">';
					buyer_msg += '<div class="mui-media-body" style="height:35px;margin-top:0px;">';
					buyer_msg += '<img height="32px" width="32px" src="' + buyer_photo + '" />';
					buyer_msg += '<font size="2" vertical-align="middle">' + buyer_nickname + '</font>';
					buyer_msg += '</div>';
					if(buyer_comm_info.length > 1) {
						buyer_msg += '<img id="moreicon" src="../../images/morebut.png" style="position:absolute;float:right;margin-left:72%;width: 25px; height: 25px;">';
					}
					buyer_msg += '<img style="height:85px;width:128px;" class="mui-media-object" src="' + buyer_comm_img + '" onerror="this.src=' + "'../../images/nopic.jpg'" + '">';
					buyer_msg += '</a>';
					buyer_msg += '<input type="hidden" name="buyer_commodity_id" value="' + buyer_comm_id + '">';
					buyer_msg += '<input type="hidden" id="buyer_user_id" name="buyer_user_id" value="' + buyer_id + '">';

					if(buyer_flag) {
						$(".cur-user").html(buyer_msg);
						$(".request-user").html(seller_msg);
					} else {
						$(".request-user").html(buyer_msg);
						$(".cur-user").html(seller_msg);
					}
					$(".cur-user").append("<input type='hidden' name='myid' id='myid' value='" + cur_user_id + "'>");
				} else {
					seller_msg += '<a href="#">';
					seller_msg += '<div class="mui-media-body" style="height:35px;margin-top:0px;">';
					seller_msg += '<img height="32px" width="32px" src="' + seller_photo + '" />';
					seller_msg += '<font size="2" vertical-align="middle">' + seller_nickname + '</font>';
					seller_msg += '</div>';
					seller_msg += '<img style="height:85px;width:128px;" class="mui-media-object" src="' + seller_comm_img + '" onerror="this.src=' + "'../../images/nopic.jpg'" + '">';
					seller_msg += '</a>';
					$(".other li").html(seller_msg);
				}

			}

			function goods_detail(cur_user_id, comminfo, flag) {
				var detailPage = null;
				var cur_comm_arr = new Array();
				var request_user_arr = new Array();
				var cur_commid = '';
				for(var c in comminfo) {
					if(cur_user_id == comminfo[c].user_id) {
						cur_comm_arr.push(comminfo[c]);
						cur_commid += comminfo[c].commodity_id + ',';
					} else {
						request_user_arr.push(comminfo[c]);
					}
				}
				cur_commid = cur_commid.substr(0, cur_commid.length - 1);
				if(flag != 'my') {
					if(request_user_arr.length == 1) {
						var commid = request_user_arr[0].commodity_id;
						if(!detailPage) {
							detailPage = plus.webview.getWebviewById('detail');
						}
						mui.fire(detailPage, 'cid', {
							id: commid
						});
						setTimeout(function() {
							mui.openWindow({
								id: 'detail',
								waiting: {
									autoShow: false
								},
								show: {
									duration: 200
								}
							});
						}, 300);
					} else {
						jumpToOtherPage('./request_item.html','requestitem',trans_id);
					}
				} else {
					jumpToOtherPage('./change_item.html','change_item',trans_id);
				}
			}

			mui(".exchange").on('tap', '.request-user', function() {
				var cur_user_id = $("#myid").val();
				var params = {
					"transid": trans_id
				};
				trans_flow('transEdite', params,'request');
			})
			
			mui(".exchange").on('tap', '.cur-user', function() {
				var cur_user_id = $("#myid").val();
				var trans_type = $("#trans_type").val();
				if(trans_type == 1) return false;
				var params = {
					"transid": trans_id
				};
				trans_flow('transEdite', params,'my');
			})

			function showChatMsg(usersinfo, messginfo, cur_user_id) {
				var buyer_photo, buyer_nickname, buyer_id, seller_photo, seller_nickname, seller_id, chatMsg;
				for(var user in usersinfo) {
					if(usersinfo[user].user_role == "issue") {
						buyer_photo = usersinfo[user].photo;
						buyer_nickname = usersinfo[user].nick_name;
						buyer_id = usersinfo[user].user_id;
					} else if(usersinfo[user].user_role == 'accept') {
						seller_photo = usersinfo[user].photo;
						seller_nickname = usersinfo[user].nick_name;
						seller_id = usersinfo[user].user_id;
					}
				}

				for(var chat in messginfo) {
					if(cur_user_id == buyer_id) {
						if(messginfo[chat].user_id == buyer_id) {
							chatMsg += '<div class="comtent mui-pull-left">';
							chatMsg += '<div class="mui-pull-right"><img src="' + buyer_photo + '" width="40" height="40" class="ka_touxiangimg"></div>';

							chatMsg += '<div class="mui-pull-right ka_commentinfobox">' + messginfo[chat].msg_detail + '</div>';
							chatMsg += '</div>';
						} else {
							chatMsg += '<div class="comtent mui-pull-left">';
							chatMsg += '<div class="mui-pull-left"><img src="' + seller_photo + '" width="40" height="40" class="ka_touxiangimg"></div>';
							chatMsg += '<div class="mui-pull-left ka_commentinfobox">' + messginfo[chat].msg_detail + '</div>';
							chatMsg += '</div>';
						}
					} else {
						if(messginfo[chat].user_id == seller_id) {
							chatMsg += '<div class="comtent mui-pull-left">';
							chatMsg += '<div class="mui-pull-right"><img src="' + seller_photo + '" width="40" height="40" class="ka_touxiangimg"></div>';
							chatMsg += '<div class="mui-pull-right ka_commentinfobox">' + messginfo[chat].msg_detail + '</div>';
							chatMsg += '</div>';
						} else {
							chatMsg += '<div class="comtent mui-pull-left">';
							chatMsg += '<div class="mui-pull-left"><img src="' + buyer_photo + '" width="40" height="40" class="ka_touxiangimg"></div>';
							chatMsg += '<div class="mui-pull-left ka_commentinfobox">' + messginfo[chat].msg_detail + '</div>';
							chatMsg += '</div>';
						}
					}
				}
				$("#msgArea").html(chatMsg);
			}

			function showRequestStaus(transinfo, userinfo) {
				var status = transinfo[0].status;
				var trans_mode = transinfo[0].trans_mode;
				var trans_type = transinfo[0].trans_type;
				var deliver = transinfo[0].deliver;
				var buyer_flag = $("#buyer_flag").val();
				var params = {
					"transid": trans_id
				};
				var buyer_id = transinfo[0].issue_user_id;
				if(trans_type == 0) {
					$(".tran-button-sell font").text(TextMessage.requestStop);
				} else {
					$(".tran-button-sell font").text(TextMessage.transStop);
				}
				var buyer_deliver, seller_deliver, buyer_urge_r, seller_urge_r, buyer_urge_d, seller_urge_d, buyer_receipt, seller_receipt;
				for(var u in userinfo) {
					if(userinfo[u].user_id == buyer_id) {
						buyer_deliver = userinfo[u].deliver_flag;
						buyer_urge_r = userinfo[u].urge_r_flag;
						buyer_urge_d = userinfo[u].urge_d_flag;
						buyer_receipt = userinfo[u].receipt_flag;
					} else {
						seller_deliver = userinfo[u].deliver_flag;
						seller_urge_r = userinfo[u].urge_r_flag;
						seller_urge_d = userinfo[u].urge_d_flag;
						seller_receipt = userinfo[u].receipt_flag;
					}
				}
				if(status == 8) {
					mui.alert(TextMessage.transStopMsg);
					var preView = plus.webview.getWebviewById('selectitem');
					plus.webview.close(preView);
					gotoMain();
				} else if(status == 3) {
					mui.alert(TextMessage.transSuccessMsg);
					jumpToOtherPage('./transevaluate.html','transevaluate',trans_id);
				} else if(status == 0) {
					if(trans_mode > 0) {
						if(buyer_flag == 'false') {
							$(".tran-button-buy font").text(TextMessage.transConfirm);
						} else {
							if(trans_mode == 1) {
								$(".tran-button-buy font").text(TextMessage.transWaitConfirm);
							} else {
								//$(".tran-button-buy font").text("订单申请");
								$(".tran-button-buy").hide();
								$(".tran-button").css('text-align', 'center');
							}
						}
					} else {
						if(buyer_flag == 'false') {
							$(".tran-button-buy font").text(TextMessage.transConfirm);
						} else {
							$(".tran-button-buy font").text(TextMessage.transWaitConfirm);
						}

					}
				} else if(status == 1) {
					if(buyer_flag == 'true') {
						if(trans_type == 0) {
							$(".tran-button-buy font").text(TextMessage.transOrder);
						} else {
							if(trans_mode == 0) {
								if(buyer_deliver == 1 && seller_deliver == 0) {
									$(".tran-button-buy font").text(TextMessage.transUrgeDelive);
								} else if(buyer_deliver == 1 && seller_deliver == 1) {
									$(".tran-button-buy font").text(TextMessage.transReceipt);
								} else {
									$(".tran-button-buy font").text(TextMessage.transDelive);
								}
							} else {
								$(".tran-button-buy font").text(TextMessage.transReceipt);
							}
						}
					} else {
						if(trans_type == 0) {
							$(".tran-button-buy font").text(TextMessage.transWaitOrder);
						} else {
							if(seller_deliver == 1 && buyer_deliver == 0) {
								$(".tran-button-buy font").text(TextMessage.transUrgeDelive);
							} else if(buyer_deliver == 1 && seller_deliver == 1) {
								$(".tran-button-buy font").text(TextMessage.transReceipt);
							} else {
								$(".tran-button-buy font").text(TextMessage.transDelive);
							}
						}
					}
				} else if(status == 2) {
					if(buyer_flag == 'true') {
						if(trans_mode != 0) {
							if(deliver == 0) {
								$(".tran-button-buy font").text(TextMessage.transUrgeDelive);
							} else {
								$(".tran-button-buy font").text(TextMessage.transReceipt);
							}
						} else {
							if(buyer_deliver == 1 && seller_deliver == 0) {
								$(".tran-button-buy font").text(TextMessage.transUrgeDelive);
							} else if(buyer_deliver == 1 && seller_deliver == 1) {
								if(buyer_receipt == 0) {
									$(".tran-button-buy font").text(TextMessage.transReceipt);
								} else if(buyer_receipt == 1 && seller_receipt == 0) {
									$(".tran-button-buy font").text(TextMessage.transUrgeReceipt);
								} else {
									$(".tran-button-buy font").text(TextMessage.transFinish);
								}
							} else {
								$(".tran-button-buy font").text(TextMessage.transDelive);
							}
						}
					} else {
						if(trans_mode != 0) {
							if(deliver == 0) {
								$(".tran-button-buy font").text(TextMessage.transDelive);
							} else {
								$(".tran-button-buy font").text(TextMessage.transWaitReceipt);
							}
						} else {
							if(seller_deliver == 1 && buyer_deliver == 0) {
								$(".tran-button-buy font").text(TextMessage.transUrgeDelive);
							} else if(buyer_deliver == 1 && seller_deliver == 1) {
								if(seller_receipt == 0) {
									$(".tran-button-buy font").text(TextMessage.transReceipt);
								} else if(buyer_receipt == 1 && seller_receipt == 0) {
									$(".tran-button-buy font").text(TextMessage.transUrgeReceipt);
								} else {
									$(".tran-button-buy font").text(TextMessage.transFinish);
								}
							} else {
								$(".tran-button-buy font").text(TextMessage.transDelive);
							}
						}
					}
				}
			}

			mui(".tran-button-buy").on('tap', 'div', function() {
				var params = {
					"transid": trans_id
				};
				var status = $("#trans_status").val();
				var trans_mode = $("#trans_mode").val();
				var trans_type = $("#trans_type").val();
				var deliver = $("#trans_deliver").val();
				var buyer_flag = $("#buyer_flag").val();
				var buyer_deliver = $("#buyer_deliver").val();
				var buyer_urge_r = $("#buyer_urge_r").val();
				var buyer_urge_d = $("#buyer_urge_d").val();
				var buyer_receipt = $("#buyer_receipt").val();
				var seller_deliver = $("#seller_deliver").val();
				var seller_urge_r = $("#seller_urge_r").val();
				var seller_urge_d = $("#seller_urge_d").val();
				var seller_receipt = $("#seller_receipt").val();
				if(status == 0) {
					trans_flow('transRequestOrder', params,'');
				} else if(status == 1) {
					trans_flow('transSubmitOrder', params,'');
				} else if(status == 2) {
					if(buyer_flag == 'true') {
						if(trans_mode != 0) {
							if(deliver == 0) {
								trans_flow('transUrgeDelive', params,'');
							} else {
								params.charity = 0;
								trans_flow('transOrderReceipt', params,'');
							}
						} else {
							if(buyer_deliver == 1 && seller_deliver == 0) {
								trans_flow('transUrgeDelive', params,'');
							} else if(buyer_deliver == 1 && seller_deliver == 1) {
								if(buyer_receipt == 0) {
									params.charity = 0;
									trans_flow('transOrderReceipt', params,'');
								} else if(buyer_receipt == 1 && seller_receipt == 0) {
									trans_flow('transUrgeReceipt', params,'');
								} else {
									gotoEvaluate(trans_id);
								}
							} else if(buyer_deliver == 0) {
								trans_flow('transOrderLogustics', params,'');
							}
						}
					} else {
						if(trans_mode != 0) {
							if(deliver == 0) {
								trans_flow('transOrderLogustics', params,'');
							}
						} else {
							if(buyer_deliver == 0 && seller_deliver == 1) {
								trans_flow('transUrgeDelive', params,'');
							} else if(buyer_deliver == 1 && seller_deliver == 1) {
								if(seller_receipt == 0) {
									params.charity = 0;
									trans_flow('transOrderReceipt', params,'');
								} else if(buyer_receipt == 1 && seller_receipt == 0) {
									trans_flow('transUrgeReceipt', params,'');
								} else {
									gotoEvaluate(trans_id);
								}
							} else if(seller_deliver == 0) {
								trans_flow('transOrderLogustics', params,'');
							}
						}
					}
				} else if(status == 3) {
					gotoEvaluate(trans_id);
				} else if(status == 7) {
					gotoEvaluate(trans_id);
				} else if(status == 8) {
					var preView = plus.webview.getWebviewById('selectitem');
					plus.webview.close(preView);
					gotoMain();
				} else if(status == 9) {
					gotoEvaluate(trans_id);
				}
			})

			function trans_flow(api_url_flag, params,flag) {
				Repository.Transaction.trans(api_url_flag, params, {
					ok: function(data) {
						if(api_url_flag == 'transOrderReceipt') {
							gotoEvaluate(params.transid);
						} else {
							Log.i("message send successfully!");
							var transinfo = data.data.transinfo;
							var messginfo = data.data.messginfo;
							var commdinfo = data.data.commdinfo;
							var usersinfo = data.data.usersinfo;
							var buyer_flag = false;
							
							var tranStatusVal = getTransStatus(transinfo.status);
							$(".tran-name-middle-status font").html(tranStatusVal);
							var buyer_id = transinfo[0].issue_user_id;
							var seller_id = transinfo[0].accept_user_id;
							var cur_user_id = data.myid;
							var trans_mode = transinfo[0].trans_mode;
							var trans_status = transinfo[0].status;
							var trans_deliver = transinfo[0].deliver;
							var trans_type = transinfo[0].trans_type;
							if(buyer_id == cur_user_id) buyer_flag = 'true';
							if(flag == 'my') goods_detail(cur_user_id, commdinfo, 'my');
							else if(flag == 'request') goods_detail(cur_user_id, commdinfo, 'request');
							if(api_url_flag == 'transConversation'){
								if(messginfo) {
									showChatMsg(usersinfo, messginfo, cur_user_id);
								}
							}
							if(trans_mode > 0) {
								$(".exchange").hide();
								$(".other").show();
							} else {
								$(".exchange").show();
								$(".other").hide();
							}
							setHidVal(transinfo, usersinfo, cur_user_id);
							showRequestStaus(transinfo, usersinfo);
							showTranCommodMsg(transinfo, usersinfo, commdinfo, cur_user_id);
							if(messginfo) {
								showChatMsg(usersinfo, messginfo, cur_user_id);
							}
							tranStatusVal = trans_type == 0 ? TextMessage.tranStatusRequest : TextMessage.tranStatusDeal;
							$(".tran-name-middle-status font").html(tranStatusVal);

						}
					},
					ng: function(data) {
						Log.i("message send faild!");
						Api.callback_ng(data);
					}
				});
			}

			function change_price() {
				var new_price = '';
				var params = {
					"transid": trans_id
				};
				var btnArray = ['取消', '确定'];
				mui.prompt('请输修改后的价格：', '', '改价', btnArray, function(e) {
					if(e.index == 1) {
						new_price = e.value;
						params.price = new_price;
						Repository.Transaction.transChangePrice(params, {
							ok: function(data) {
								Log.i("message send successfully!");
								mui.alert('价格改变成功');
								$(".change_price").hide();
							},
							ng: function(data) {
								Api.callback_ng(data);
							}
						});
					} else {
						info.innerText = '确认不变更？';
					}
				})
			}

			function gotoEvaluate(transid) {
				mui.openWindow({
					url: "./transevaluate.html?transid=" + trans_id,
					id: "transevaluate",
					extras: {
						"transid": transid
					}
				})
			}
			
			function jumpToOtherPage(pageurl,pageid,transid){
				mui.openWindow({
					url:pageurl,
					id:pageid,
					extras: {
						"transid": transid
					}
				})
			}
			
			function gotoMain() {
				mui.plusReady(function() {
					var requestView = plus.webview.getWebviewById('request');
					plus.webview.close(requestView);
					var requestlistView = plus.webview.getWebviewById('requestlist');
					plus.webview.close(requestlistView);
					var mainpage = plus.webview.getWebviewById('pullrefresh_with_tab');
					mui.back();
					mui.fire(mainpage, 'refresh', {
						refresh: "canRefresh"
					});
				});
			}

			function stopTransaction() {
				var params = {
					"transid": trans_id
				};
				var btnArray = [TextMessage.confirmBtnNo, TextMessage.confirmBtnYes];
				var trans_type = $("#trans_type").val();

				mui.confirm(TextMessage.transStopTips, 'kankan', btnArray, function(e) {
					if(e.index == 1) {
						Repository.Transaction.transStop(params, {
							ok: function(data) {
								Log.i("message send successfully!");
								if(trans_type == 1) {
									gotoEvaluate(trans_id);
								} else {
									gotoMain();
								}
							},
							ng: function(data) {
								Api.callback_ng(data);
							}
						});
					} else {
						alert(TextMessage.transContinue);
					}
				})
			}
		</script>
	</body>

</html>