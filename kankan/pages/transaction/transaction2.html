<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>translatelist</title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link rel="stylesheet" href="../../css/mui.min.css" />
		<link href="../../css/icons-extra.css" rel="stylesheet" />
		<script src="../../jquery-3.2.0.min.js"></script>
		<style>
			html,
			body {
				background-color: #efeff4;
			}
		</style>
		<link rel="stylesheet" type="text/css" href="../../css/feedback.css" />
		<link rel="stylesheet" href="../../css/kankan_home.css">
		<link href="../../css/wu.css" rel="stylesheet" />
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav"></a>
			<a class="lang" data-locale="back">戻る</a>
			<h1 class="mui-title"><span class="lang" data-locale="change">Tran</span></h1>
		</header>
		<div class="mui-content">
			<div id="mui-page-content">
				<div class="tran-page">
					<div class="tran-body" style="margin-bottom:60px;">
						<div class="tran-name-middle-status mui-center">
							<font size="2" color="#ffffff" vertical-align="middle">問い合わせ中</font>
						</div>
						<ul class="mui-table-view mui-grid-view exchange" style="display:none;margin-top:0px;position: inherit;padding:0 10px 10px 10px">
							<li class="mui-table-view-cell mui-media mui-col-xs-5 cur-user">

							</li>
							<li class="tran-pic-middle" style="margin-left:10px;">
								<img height="24px" width="24px" src="../../images/xinhuan.png" />
							</li>
							<li class="mui-table-view-cell mui-media mui-col-xs-5 request-user">

							</li>
						</ul>
						<ul class="mui-table-view mui-grid-view other" style="display:none;text-align:center;margin-top:0px;position: inherit;padding:0 10px 10px 10px">
							<li class="mui-table-view-cell mui-media mui-col-xs-5">

							</li>
						</ul>
						<ul class="tran-button">
							<li class="tran-button-sell">
								<div>
									<font size="2" vertical-align="middle" onclick="stopTransaction();">交易中止</font>
								</div>
							</li>
							<li class="tran-button-middle">
							</li>
							<li class="tran-button-buy">
								<div>
									<font size="2" color="#FFFFF" vertical-align="middle"></font>
								</div>
							</li>
						</ul>
						<input type="hidden" id="trans_status" name="trans_status" value="" />
						<input type="hidden" id="trans_mode" name="trans_mode" value="" />
						<input type="hidden" id="trans_type" name="trans_type" value="" />
						<input type="hidden" id="trans_deliver" name="trans_deliver" value="" />
						<input type="hidden" id="buyer_flag" name="buyer_flag" value="" />
						<ul class="tran-distribution change_price" style="display:none;" onclick="change_price();">
							<li class="tran-distribution-law">
								<a href="../main/logisticslist.html">
									<div class="tran-distribution-call">
										<font size="2" color="#FFFFF" vertical-align="middle">改价</font>
										</font>
									</div>
								</a>
							</li>
						</ul>
						<ul class="tran-distribution">
							<li class="tran-distribution-law">
								<div class="tran-distribution-law-detail">
									<a href="#tradeLaw">
										<font size="3" color="999999" vertical-align="middle">特定商取引法に基づく表記</font>
									</a>
								</div>
								<a href="../main/logisticslist.html">
									<div class="tran-distribution-call">
										<font size="2" color="#FFFFF" vertical-align="middle">物流と連絡する</font>
									</div>
								</a>
							</li>
						</ul>
						<ul id="msgArea" class="tran-chat">
						</ul>
					</div>
				</div>
			</div>
		</div>
		<nav class="mui-bar mui-bar-tab">
			<ul class="tran-foot">
				<li class="tran-foot-input">
					<input id="msg" type="text" value="" />
				</li>
				<li class="tran-foot-submit">
					<button type="button" onclick="submitChat();" class="mui-btn-link mui-btn-nav mui-pull-left">
						<span><font size="4">送信<font size="4"></span>
					</button>
				</li>
			</ul>
		</nav>
		<script type="text/javascript" src="../../js/mui.min.js"></script>
		<script type="text/javascript" src="../../js/jquery-3.2.0.min.js"></script>
		<script type="text/javascript" src="../../js/sha256.js"></script>
		<script type="text/javascript" src="../../js/common.js"></script>
		<script type="text/javascript" charset="utf-8">
			mui.init();
			var trans_id;
			mui.plusReady(function() {
				var self = plus.webview.currentWebview();
				trans_id = self.transid;
				var preView = plus.webview.getWebviewById('requestlist');
				plus.webview.close(preView);
				showRequestDetail();
			})

			function submitChat() {
				var chatMsg = $("#msg").val();
				if(chatMsg == '') {
					mui.toast("内容はありませんね");
					$("#msg").focus();
				} else {
					var params = {
						"message": chatMsg,
						"transid": trans_id
					};
					Repository.Transaction.transConversation(params, {
						ok: function(data) {
							Log.i("message send successfully!");
							$("#msg").val("");
							var transinfo = data.data.transinfo;
							var messginfo = data.data.messginfo;
							var commdinfo = data.data.commdinfo;
							var usersinfo = data.data.usersinfo;
							var cur_user_id = data.data.myid;
							if(messginfo) {
								showChatMsg(usersinfo, messginfo, cur_user_id);
							}
						},
						ng: function(data) {
							Log.i("message send faild!");
							if(data == "1000") {
								alert(TextMessage.test);
							}
							if(data == "2004") {
								alert(TextMessage.operation_error);
							}
						}
					});
				}
			}

			function showRequestDetail() {
				var params = {
					"transid": trans_id
				};
				Repository.Transaction.transEdite(params, {
					ok: function(data) {
						var transinfo = data.data.transinfo;
						var messginfo = data.data.messginfo;
						var commdinfo = data.data.commdinfo;
						var usersinfo = data.data.usersinfo;
						var buyer_flag = false;
						var tranStatusVal = getTransStatus(transinfo.status);
						$(".tran-name-middle-status font").html(tranStatusVal);
						//showTranCommodMsg(usersinfo, commdinfo, messginfo);
						var buyer_id = transinfo[0].issue_user_id;
						var seller_id = transinfo[0].accept_user_id;
						var cur_user_id = data.myid;
						var trans_mode = transinfo[0].trans_mode;
						var trans_status = transinfo[0].status;
						var trans_deliver = transinfo[0].deliver;
						if(buyer_id == cur_user_id) buyer_flag = 'true';
						$("#trans_status").val(trans_status);
						$("#trans_mode").val(trans_mode);
						$("#trans_deliver").val(trans_deliver);
						$("#buyer_flag").val(buyer_flag);
						if(trans_mode > 0) {
							$(".exchange").hide();
							$(".other").show();
						} else {
							$(".exchange").show();
							$(".other").hide();
						}
						showTranCommodMsg(transinfo, usersinfo, commdinfo, cur_user_id);
						if(messginfo) {
							showChatMsg(usersinfo, messginfo, cur_user_id);
						}
						showRequestStaus(trans_status, trans_mode, trans_deliver, buyer_flag);
					},
					ng: function(data) {
						if(data == "1000") {
							alert(TextMessage.test);
						}
						if(data == "2004") {
							alert(TextMessage.operation_error);
						}
					}
				});
			}

			function getTransStatus(status) {
				var tranStatusVal = TRANS_STATUS[status];
				return tranStatusVal;
			}

			function showTranCommodMsg(transinfo, usersinfo, commdinfo, cur_user_id) {
				var buyer_photo, buyer_nickname, buyer_id, seller_photo, seller_nickname, seller_id, trans_mode, buyer_msg = '',
					seller_msg = '';
				for(var user in usersinfo) {
					if(usersinfo[user].user_role == "issue") {
						buyer_photo = usersinfo[user].photo;
						buyer_nickname = usersinfo[user].nick_name;
						buyer_id = usersinfo[user].user_id;
					} else if(usersinfo[user].user_role == 'accept') {
						seller_photo = usersinfo[user].photo;
						seller_nickname = usersinfo[user].nick_name;
						seller_id = usersinfo[user].user_id;
					}
				}

				for(var goods in commdinfo) {
					if(commdinfo[goods].user_id == buyer_id) {
						buyer_comm_id = commdinfo[goods].commodity_id;
						buyer_comm_img = commdinfo[goods].img_flg;
						buyer_comm_name = commdinfo[goods].comm_name;
					} else {
						seller_comm_id = commdinfo[goods].commodity_id;
						seller_comm_img = commdinfo[goods].img_flg;
						seller_comm_name = commdinfo[goods].comm_name;
					}
				}
				var buyer_flag = false;
				if(cur_user_id == buyer_id) buyer_flag = true;
				var trans_mode = transinfo[0].trans_mode;
				if(trans_mode == 0) {
					seller_msg += '<a href="#">';
					seller_msg += '<div class="mui-media-body" style="height:35px;margin-top:0px;">';
					seller_msg += '<img height="32px" width="32px" src="' + seller_photo + '" />';
					seller_msg += '<font size="2" vertical-align="middle">' + seller_nickname + '</font>';
					seller_msg += '</div>';
					seller_msg += '<img style="height:85px;width:128px;" class="mui-media-object" src="' + seller_comm_img + '">';
					seller_msg += '</a>';
					seller_msg += '<input type="hidden" name="seller_commodity_id" value="' + seller_comm_id + '">';
					seller_msg += '<input type="hidden" name="seller_user_id" value="' + seller_id + '">';
					buyer_msg += '<a href="#">';
					buyer_msg += '<div class="mui-media-body" style="height:35px;margin-top:0px;">';
					buyer_msg += '<img height="32px" width="32px" src="' + buyer_photo + '" />';
					buyer_msg += '<font size="2" vertical-align="middle">' + buyer_nickname + '</font>';
					buyer_msg += '</div>';
					buyer_msg += '<img style="height:85px;width:128px;" class="mui-media-object" src="' + buyer_comm_img + '">';
					buyer_msg += '</a>';
					buyer_msg += '<input type="hidden" name="buyer_commodity_id" value="' + buyer_comm_id + '">';
					buyer_msg += '<input type="hidden" name="buyer_user_id" value="' + buyer_id + '">';
					
					if(buyer_flag) {
						$(".cur-user").html(buyer_msg);
						$(".request-user").html(seller_msg);
					} else {
						$(".request-user").html(buyer_msg);
						$(".cur-user").html(seller_msg);
					}
					$(".cur-user").append("<input type='hidden' name='myid' id='myid' value='" + cur_user_id + "'>");
				} else {
					seller_msg += '<a href="#">';
					seller_msg += '<div class="mui-media-body" style="height:35px;margin-top:0px;">';
					seller_msg += '<img height="32px" width="32px" src="' + seller_photo + '" />';
					seller_msg += '<font size="2" vertical-align="middle">' + seller_nickname + '</font>';
					seller_msg += '</div>';
					seller_msg += '<img style="height:85px;width:128px;" class="mui-media-object" src="' + seller_comm_img + '">';
					seller_msg += '</a>';
					$(".other li").html(seller_msg);
				}

			}

			function goods_detail() {
				
			}

			function show_request_comm() {

			}
			
			mui(".exchange").on('tap', '.cur-user', function() {
				var cur_user_id = $("#myid").val();
				alert(cur_user_id);
			})
			function showChatMsg(usersinfo, messginfo, cur_user_id) {
				var buyer_photo, buyer_nickname, buyer_id, seller_photo, seller_nickname, seller_id, chatMsg;
				for(var user in usersinfo) {
					if(usersinfo[user].user_role == "issue") {
						buyer_photo = usersinfo[user].photo;
						buyer_nickname = usersinfo[user].nick_name;
						buyer_id = usersinfo[user].user_id;
					} else if(usersinfo[user].user_role == 'accept') {
						seller_photo = usersinfo[user].photo;
						seller_nickname = usersinfo[user].nick_name;
						seller_id = usersinfo[user].user_id;
					}
				}

				for(var chat in messginfo) {
					if(cur_user_id == buyer_id) {
						if(messginfo[chat].user_id == buyer_id) {
							chatMsg += '<div class="comtent mui-pull-left">';
							chatMsg += '<div class="mui-pull-right"><img src="' + buyer_photo + '" width="40" height="40" class="ka_touxiangimg"></div>';

							chatMsg += '<div class="mui-pull-right ka_commentinfobox">' + messginfo[chat].msg_detail + '</div>';
							chatMsg += '</div>';
						} else {
							chatMsg += '<div class="comtent mui-pull-left">';
							chatMsg += '<div class="mui-pull-left"><img src="' + seller_photo + '" width="40" height="40" class="ka_touxiangimg"></div>';
							chatMsg += '<div class="mui-pull-left ka_commentinfobox">' + messginfo[chat].msg_detail + '</div>';
							chatMsg += '</div>';
						}
					} else {
						if(messginfo[chat].user_id == seller_id) {
							chatMsg += '<div class="comtent mui-pull-left">';
							chatMsg += '<div class="mui-pull-right"><img src="' + seller_photo + '" width="40" height="40" class="ka_touxiangimg"></div>';
							chatMsg += '<div class="mui-pull-right ka_commentinfobox">' + messginfo[chat].msg_detail + '</div>';
							chatMsg += '</div>';
						} else {
							chatMsg += '<div class="comtent mui-pull-left">';
							chatMsg += '<div class="mui-pull-left"><img src="' + buyer_photo + '" width="40" height="40" class="ka_touxiangimg"></div>';
							chatMsg += '<div class="mui-pull-left ka_commentinfobox">' + messginfo[chat].msg_detail + '</div>';
							chatMsg += '</div>';
						}
					}
				}
				$("#msgArea").html(chatMsg);
			}

			function showRequestStaus(status, trans_mode, deliver, buyer_flag) {
				var params = {
					"transid": trans_id
				};

				if(status == 8) {
					mui.alert('已终止交易，不能继续交易。如果要继续交易请重新请求！！');
				} else if(status == 3) {
					mui.alert('交易已完成！！');
					//var curView = plus.webview.currentWebview();
					//plus.webview.close(curView);
					mui.openWindow({
						url: "./transevaluate.html?transid=" + trans_id,
						id: "transevaluate",
						extras: {
							"transid": trans_id
						}
					})
				} else if(status == 0) {
					if(trans_mode > 0) {
						if(buyer_flag == false) {
							//$(".tran-button-buy").hide();
							$(".tran-button-buy font").text("确认交易");
						} else {
							if(trans_mode == 1) {
								$(".tran-button-buy font").text("等待对方确认");
							} else {
								$(".tran-button-buy font").text("确认交易");
								//$(".tran-button-buy font").hide();
							}
						}
					} else {
						$(".tran-button-buy font").text("确认交易");
					}
				} else if(status == 1) {
					if(buyer_flag) {
						$(".tran-button-buy font").text("订单生成");
					} else {
						$(".tran-button-buy ").hide();
					}
				} else if(status == 2) {
					if(buyer_flag) {
						if(deliver == 1) {
							$(".tran-button-buy font").text("确认收货");
						} else {
							$(".tran-button-buy font").text("催促发货");
						}
					} else {
						if(deliver == 1) {
							$(".tran-button-buy font").text("催促卖家收货");
						} else {
							$(".tran-button-buy font").text("确认发货");
						}
					}
				}
			}
			
			mui(".tran-button-buy").on('tap', 'div', function() {
				var params = {
					"transid": trans_id
				};
				var status = $("#trans_status").val();
				var mode = $("#trans_mode").val();
				var deliver = $("#trans_deliver").val();
				var buyer_flag = $("#buyer_flag").val();
				if(status == 0) {
					Repository.Transaction.transRequestOrder(params, {
						ok: function(data) {
							Log.i("message send successfully!");
							console.dir("data");
							mui.alert('订单生成！！');
						},
						ng: function(data) {
							Log.i("message send faild!");
							if(data == "1000") {
								alert(TextMessage.test);
							}
							if(data == "2004") {
								alert(TextMessage.operation_error);
							}
						}
					});
				} else if(status == 2 && deliver == 1 && buyer_flag === 'true') {
					params.charity = 0;
					Repository.Transaction.transOrderReceipt(params, {
						ok: function(data) {
							Log.i("message send successfully!");
							console.dir("data");
							mui.alert('交易成功！！')
							mui.openWindow({
								url: "./transevaluate.html?transid=" + trans_id,
								id: "transevaluate",
								extras: {
									"transid": trans_id
								}
							})
						},
						ng: function(data) {
							Log.i("message send faild!");
							if(data == "1000") {
								alert(TextMessage.test);
							}
							if(data == "2004") {
								alert(TextMessage.operation_error);
							}
						}
					});
				} else if(status == 2 && deliver == 0 && buyer_flag == 'true') {
					Repository.Transaction.transUrgeDelive(params, {
						ok: function(data) {
							Log.i("message send successfully!");
							var transinfo = data.data.transinfo;
							var messginfo = data.data.messginfo;
							var commdinfo = data.data.commdinfo;
							var usersinfo = data.data.usersinfo;
							var tranStatusVal = getTransStatus(transinfo.status);
							$(".tran-name-middle-status font").html(tranStatusVal);
							//showTranCommodMsg(usersinfo, commdinfo, messginfo);
							var buyer_id = transinfo.issue_user_id;
							var seller_id = transinfo.accept_user_id;
							var cur_user_id = data.data.myid;
							var trans_mode = transinfo[0].trans_mode;
							var trans_status = transinfo[0].status;
							var trans_deliver = transinfo[0].deliver;
							$("#trans_status").val(trans_status);
							$("#trans_mode").val(trans_mode);
							$("#trans_deliver").val(trans_deliver);
							$("#buyer_flag").val(buyer_flag);
							showRequestStaus(trans_status, trans_mode, trans_deliver, buyer_flag);

						},
						ng: function(data) {
							Log.i("message send faild!");
							if(data == "1000") {
								alert(TextMessage.test);
							}
							if(data == "2004") {
								alert(TextMessage.operation_error);
							}
						}
					});
				} else if(status == 2 && deliver == 0 && buyer_flag == 'false') {
					Repository.Transaction.transOrderLogustics(params, {
						ok: function(data) {
							Log.i("message send successfully!");
							console.dir("data");
							var transinfo = data.data.transinfo;
							var messginfo = data.data.messginfo;
							var commdinfo = data.data.commdinfo;
							var usersinfo = data.data.usersinfo;
							var tranStatusVal = getTransStatus(transinfo.status);
							$(".tran-name-middle-status font").html(tranStatusVal);
							//showTranCommodMsg(usersinfo, commdinfo, messginfo);
							var buyer_id = transinfo.issue_user_id;
							var seller_id = transinfo.accept_user_id;
							var cur_user_id = data.data.myid;
							var trans_mode = transinfo[0].trans_mode;
							var trans_status = transinfo[0].status;
							var trans_deliver = transinfo[0].deliver;
							$("#trans_status").val(trans_status);
							$("#trans_mode").val(trans_mode);
							$("#trans_deliver").val(trans_deliver);
							showRequestStaus(trans_status, trans_mode, trans_deliver, buyer_flag);
						},
						ng: function(data) {
							Log.i("message send faild!");
							if(data == "1000") {
								alert(TextMessage.test);
							}
							if(data == "2004") {
								alert(TextMessage.operation_error);
							}
						}
					});
				} else if(status == 2 && deliver == 1 && buyer_flag == 'false') {
					Repository.Transaction.transUrgeReceipt(params, {
						ok: function(data) {
							Log.i("message send successfully!");
							console.dir("data");
							var transinfo = data.data.transinfo;
							var messginfo = data.data.messginfo;
							var commdinfo = data.data.commdinfo;
							var usersinfo = data.data.usersinfo;
							var tranStatusVal = getTransStatus(transinfo.status);
							$(".tran-name-middle-status font").html(tranStatusVal);
							//showTranCommodMsg(usersinfo, commdinfo, messginfo);
							var buyer_id = transinfo.issue_user_id;
							var seller_id = transinfo.accept_user_id;
							var cur_user_id = data.data.myid;
							var trans_mode = transinfo[0].trans_mode;
							var trans_status = transinfo[0].status;
							var trans_deliver = transinfo[0].deliver;
							$("#trans_status").val(trans_status);
							$("#trans_mode").val(trans_mode);
							$("#trans_deliver").val(trans_deliver);
							showRequestStaus(trans_status, trans_mode, trans_deliver, buyer_flag);
						},
						ng: function(data) {
							Log.i("message send faild!");
							if(data == "1000") {
								alert(TextMessage.test);
							}
							if(data == "2004") {
								alert(TextMessage.operation_error);
							}
						}
					});
				} else if(status == 1) {
					Repository.Transaction.transSubmitOrder(params, {
						ok: function(data) {
							Log.i("message send successfully!");
							console.dir("data");
							var transinfo = data.data.transinfo;
							var messginfo = data.data.messginfo;
							var commdinfo = data.data.commdinfo;
							var usersinfo = data.data.usersinfo;
							var tranStatusVal = getTransStatus(transinfo.status);
							$(".tran-name-middle-status font").html(tranStatusVal);
							//showTranCommodMsg(usersinfo, commdinfo, messginfo);
							var buyer_id = transinfo.issue_user_id;
							var seller_id = transinfo.accept_user_id;
							var cur_user_id = data.data.myid;
							var trans_mode = transinfo[0].trans_mode;
							var trans_status = transinfo[0].status;
							var trans_deliver = transinfo[0].deliver;
							$("#trans_status").val(trans_status);
							$("#trans_mode").val(trans_mode);
							$("#trans_deliver").val(trans_deliver);
							showRequestStaus(trans_status, trans_mode, trans_deliver, buyer_flag);
						},
						ng: function(data) {
							Log.i("message send faild!");
							if(data == "1000") {
								alert(TextMessage.test);
							}
							if(data == "2004") {
								alert(TextMessage.operation_error);
							}
						}
					});
				}
			})

			function change_price() {
				var new_price = '';
				var params = {
					"transid": trans_id
				};
				var btnArray = ['取消', '确定'];
				mui.prompt('请输修改后的价格：', '', '改价', btnArray, function(e) {
					if(e.index == 1) {
						new_price = e.value;
						params.price = new_price;
						Repository.Transaction.transChangePrice(params, {
							ok: function(data) {
								Log.i("message send successfully!");
								mui.alert('价格改变成功');
								$(".change_price").hide();
							},
							ng: function(data) {
								Log.i("message send faild!");
								if(data == "1000") {
									alert(TextMessage.test);
								}
								if(data == "2004") {
									alert(TextMessage.operation_error);
								}
							}
						});
					} else {
						info.innerText = '确认不变更？';
					}
				})
			}

			function stopTransaction() {
				var params = {
					"transid": trans_id
				};
				var btnArray = ['否', '是'];
				mui.confirm('确认交易终止？', 'kankan', btnArray, function(e) {
					if(e.index == 1) {
						mui.openWindow({
							url: "./transevaluate.html?transid=" + trans_id,
							id: "transevaluate",
							extras: {
								"transid": trans_id
							}
						})
					} else {
						alert("继续交易");
					}
				})

				Repository.Transaction.transStop(params, {
					ok: function(data) {
						Log.i("message send successfully!");
					},
					ng: function(data) {
						Log.i("message send faild!");
						if(data == "1000") {
							alert(TextMessage.test);
						}
						if(data == "2004") {
							alert(TextMessage.operation_error);
						}
					}
				});
			}

			function err_callback(data) {
				Log.i("message send faild!");
				if(data == "1000") {
					alert(TextMessage.test);
				}
				if(data == "2004") {
					alert(TextMessage.operation_error);
				}
			}
		</script>
	</body>

</html>